<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBL Liegenschaftsinventar - Korrekturen</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="assets/swiss-logo-flag.svg" alt="Schweizerische Eidgenossenschaft" class="logo-flag">
      <div class="logo-text">
        <div class="logo-text-primary">Bundesamt für Bauten und Logistik</div>
        <div class="logo-text-secondary">Korrekturen Liegenschaftsinventar</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="karte">Karte</button>
      <button class="nav-tab" data-tab="aufgaben">Aufgaben</button>
      <button class="nav-tab" data-tab="statistik">Statistik</button>
      <button class="nav-tab" data-tab="handbuch">Einstellungen & Export</button>
    </nav>

    <div class="header-actions">
      <div class="search-container" id="search-container">
        <button class="search-toggle" id="search-toggle" type="button">
          <i data-lucide="search" class="icon"></i>
        </button>
        <input type="text" class="search-input" placeholder="Suchen..." id="globalSearch">
      </div>
      <button class="filter-toggle active" id="filter-toggle" type="button">
        <i data-lucide="sliders-horizontal" class="icon"></i>
      </button>
      <div class="user-avatar">MK</div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Global Filter Bar -->
    <div class="filter-bar" id="filter-bar">
      <div class="filter-chips">
        <button class="filter-chip priority-high active" data-filter="high">
          <span class="priority-indicator high"></span>
          <span>Hoch</span>
          <span class="count" id="count-high">(3)</span>
        </button>
        <button class="filter-chip priority-medium active" data-filter="medium">
          <span class="priority-indicator medium"></span>
          <span>Mittel</span>
          <span class="count" id="count-medium">(4)</span>
        </button>
        <button class="filter-chip priority-low active" data-filter="low">
          <span class="priority-indicator low"></span>
          <span>Niedrig</span>
          <span class="count" id="count-low">(5)</span>
        </button>
      </div>
      <div class="filter-divider"></div>
      <button class="filter-chip" data-filter="my-tasks">Meine Aufgaben</button>
      <div class="filter-divider"></div>

      <!-- Multi-select: Kanton -->
      <div class="multi-select" id="filter-kanton">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Kanton</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="TG"><span>TG</span></label>
            <label class="multi-select-option"><input type="checkbox" value="SG"><span>SG</span></label>
            <label class="multi-select-option"><input type="checkbox" value="ZH"><span>ZH</span></label>
            <label class="multi-select-option"><input type="checkbox" value="BE"><span>BE</span></label>
            <label class="multi-select-option"><input type="checkbox" value="GR"><span>GR</span></label>
            <label class="multi-select-option"><input type="checkbox" value="LU"><span>LU</span></label>
            <label class="multi-select-option"><input type="checkbox" value="GE"><span>GE</span></label>
            <label class="multi-select-option"><input type="checkbox" value="TI"><span>TI</span></label>
            <label class="multi-select-option"><input type="checkbox" value="BS"><span>BS</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Konfidenz -->
      <div class="multi-select" id="filter-confidence">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Konfidenz</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="critical"><span>Kritisch</span></label>
            <label class="multi-select-option"><input type="checkbox" value="warning"><span>Warnung</span></label>
            <label class="multi-select-option"><input type="checkbox" value="ok"><span>OK</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Portfolio -->
      <div class="multi-select" id="filter-portfolio">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Portfolio</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="Büro"><span>Büro</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Wohnen"><span>Wohnen</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Öffentlich"><span>Öffentlich</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Industrie"><span>Industrie</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Bildung"><span>Bildung</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Zugewiesen -->
      <div class="multi-select" id="filter-assignee">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Zugewiesen</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="M. Keller"><span>M. Keller</span></label>
            <label class="multi-select-option"><input type="checkbox" value="S. Brunner"><span>S. Brunner</span></label>
            <label class="multi-select-option"><input type="checkbox" value="T. Weber"><span>T. Weber</span></label>
            <label class="multi-select-option"><input type="checkbox" value="A. Meier"><span>A. Meier</span></label>
            <label class="multi-select-option"><input type="checkbox" value=""><span>Nicht zugewiesen</span></label>
          </div>
        </div>
      </div>

      <div class="filter-divider"></div>
      <button class="filter-reset-btn" id="filter-reset" type="button">
        <i data-lucide="rotate-ccw" class="icon-sm"></i>
        <span>Zurücksetzen</span>
      </button>
    </div>

    <!-- Karte Tab -->
    <div class="tab-content active" id="tab-karte">
      <div class="karte-layout">
        <!-- Map Container (map + table) -->
        <div class="map-container">
          <!-- Map Panel -->
          <div class="map-panel">
            <div id="map"></div>
            <div class="basemap-selector" id="basemap-selector">
              <div class="basemap-panel" id="basemap-panel">
                <button class="basemap-option" data-basemap="none">
                  <div class="basemap-thumb basemap-none"></div>
                  <span>Kein HG</span>
                </button>
                <button class="basemap-option" data-basemap="grey">
                  <div class="basemap-thumb basemap-grey"></div>
                  <span>Grau</span>
                </button>
                <button class="basemap-option active" data-basemap="color">
                  <div class="basemap-thumb basemap-color"></div>
                  <span>Farbig</span>
                </button>
                <button class="basemap-option" data-basemap="satellite">
                  <div class="basemap-thumb basemap-satellite"></div>
                  <span>Luftbild</span>
                </button>
              </div>
              <button class="basemap-trigger" id="basemap-trigger" title="Hintergrund wechseln">
                <div class="basemap-thumb basemap-color" id="basemap-trigger-thumb"></div>
                <span>Hintergrund</span>
              </button>
            </div>
            <button class="table-toggle-btn active" id="table-toggle-btn">
              <i data-lucide="chevron-up" class="icon-sm chevron"></i>
              <span>Tabelle</span>
            </button>
          </div>

          <!-- Table View Panel (hidden by default) -->
          <div class="table-panel visible" id="table-panel">
            <div class="table-resize-handle" id="table-resize-handle">
              <div class="resize-handle-bar"></div>
            </div>
            <div class="table-panel-header">
              <div class="table-panel-title">
                <i data-lucide="table-2" class="icon"></i>
                <span>Tabellenansicht</span>
                <span id="table-count">(0)</span>
              </div>
              <button class="table-panel-close" id="table-close-btn">
                <i data-lucide="x" class="icon"></i>
              </button>
            </div>
            <div class="table-panel-content">
              <table class="buildings-table">
                <thead>
                  <tr>
                    <th>Priorität</th>
                    <th>SAP ID</th>
                    <th>Name</th>
                    <th>Kanton</th>
                    <th>Konfidenz</th>
                    <th>Fehlertypen</th>
                    <th>Zugewiesen</th>
                    <th>Aktualisiert</th>
                  </tr>
                </thead>
                <tbody id="table-body">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Detail Panel -->
        <div class="detail-panel" id="detail-panel">
          <div class="detail-content" id="detail-content">
            <div class="detail-header">
              <button class="detail-close-btn" id="detail-close-btn" title="Schliessen">
                <i data-lucide="x"></i>
              </button>
              <h2 class="detail-title" id="detail-title">Building Name</h2>
              <p class="detail-subtitle" id="detail-sap-id">SAP ID</p>
            </div>

            <div class="detail-section accordion open" data-accordion="konfidenz">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Konfidenz</span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div class="confidence-container">
                  <div class="confidence-total" id="confidence-total">67%</div>
                  <div class="confidence-bars">
                    <div class="confidence-bar-row">
                      <span class="confidence-bar-label">Georef</span>
                      <div class="confidence-bar-track">
                        <div class="confidence-bar-fill" id="bar-georef" style="width: 67%"></div>
                      </div>
                      <span class="confidence-bar-value" id="val-georef">67%</span>
                    </div>
                    <div class="confidence-bar-row">
                      <span class="confidence-bar-label">SAP</span>
                      <div class="confidence-bar-track">
                        <div class="confidence-bar-fill ok" id="bar-sap" style="width: 100%"></div>
                      </div>
                      <span class="confidence-bar-value" id="val-sap">100%</span>
                    </div>
                    <div class="confidence-bar-row">
                      <span class="confidence-bar-label">GWR</span>
                      <div class="confidence-bar-track">
                        <div class="confidence-bar-fill ok" id="bar-gwr" style="width: 100%"></div>
                      </div>
                      <span class="confidence-bar-value" id="val-gwr">100%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section accordion" data-accordion="fehler">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Fehler</span>
                <span class="accordion-count" id="error-count"></span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div id="error-cards">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>

            <div class="detail-section accordion open" data-accordion="zugewiesen">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Zugewiesen</span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div class="assignee-display" id="assignee-display">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>

            <div class="detail-section accordion open" data-accordion="datenvergleich">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Datenvergleich</span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Attribut</th>
                      <th>SAP RE-FX</th>
                      <th>GWR</th>
                    </tr>
                  </thead>
                  <tbody id="data-comparison">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
              </div>
            </div>

            <div class="detail-actions">
              <button class="action-btn secondary" id="btn-correct">Korrigieren</button>
              <button class="action-btn success" id="btn-done">Als erledigt markieren</button>
            </div>

            <div class="detail-section accordion" data-accordion="kommentare">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Kommentare</span>
                <span class="accordion-count" id="comments-count"></span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div id="comments-list">
                  <!-- Populated by JS -->
                </div>
                <div class="comment-input-section">
                  <textarea class="comment-input" id="comment-input" placeholder="Kommentar schreiben..." rows="2"></textarea>
                  <div class="comment-actions">
                    <button class="action-btn secondary btn-sm" id="btn-cancel-comment" type="button">Abbrechen</button>
                    <button class="action-btn primary btn-sm" id="btn-submit-comment" type="button">Senden</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section accordion" data-accordion="ereignisse">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Ereignisse</span>
                <span class="accordion-count" id="events-count"></span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div class="events-list" id="events-list">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aufgaben Tab -->
    <div class="tab-content" id="tab-aufgaben">
      <div class="aufgaben-content">
        <div class="aufgaben-header">
          <h1 class="aufgaben-title">Aufgaben-Board</h1>
          <div class="aufgaben-views">
            <button class="view-btn active">Board</button>
            <button class="view-btn">Liste</button>
            <button class="view-btn">Meine Aufgaben</button>
          </div>
        </div>

        <div class="kanban-container">
          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="inbox" class="icon"></i></span>
              <span class="kanban-header-title">Offen</span>
              <span class="kanban-header-count" id="kanban-open-count">234</span>
            </div>
            <div class="kanban-cards" id="kanban-open">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="user" class="icon"></i></span>
              <span class="kanban-header-title">Zugewiesen</span>
              <span class="kanban-header-count" id="kanban-assigned-count">89</span>
            </div>
            <div class="kanban-cards" id="kanban-assigned">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="search" class="icon"></i></span>
              <span class="kanban-header-title">In Prüfung</span>
              <span class="kanban-header-count" id="kanban-review-count">34</span>
            </div>
            <div class="kanban-cards" id="kanban-review">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="check-circle" class="icon"></i></span>
              <span class="kanban-header-title">Erledigt</span>
              <span class="kanban-header-count" id="kanban-done-count">1'842</span>
            </div>
            <div class="kanban-cards" id="kanban-done">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistik Tab -->
    <div class="tab-content" id="tab-statistik">
      <div class="statistik-content">
        <div class="statistik-header">
          <div class="statistik-period">
            <span>Zeitraum:</span>
            <select class="filter-dropdown">
              <option>Letzte 30 Tage</option>
              <option>Letzte 7 Tage</option>
              <option>Dieses Jahr</option>
              <option>Gesamt</option>
            </select>
          </div>
          <button class="export-btn btn-icon"><i data-lucide="download" class="icon"></i> Export CSV</button>
        </div>

        <div class="stat-cards">
          <div class="stat-card">
            <div class="stat-label">Fortschritt</div>
            <div class="stat-value">62%</div>
            <div class="stat-change positive">+8% ↑</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Erledigt</div>
            <div class="stat-value">1'842</div>
            <div class="stat-change positive">+127 ↑</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Offen</div>
            <div class="stat-value">547</div>
            <div class="stat-change positive">-89 ↓</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ø Bearbeitungszeit</div>
            <div class="stat-value">3.2 Tage</div>
            <div class="stat-change positive">-0.5d ↑</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-card">
            <h3 class="chart-title">Gesamtfortschritt</h3>
            <div class="progress-chart">
              <div class="progress-bar-large">
                <div class="progress-bar-fill" style="width: 62%"></div>
              </div>
              <div class="progress-text">62%</div>
              <div class="progress-label">1'842 / 3'000 Objekte geprüft</div>
            </div>
          </div>
          <div class="chart-card error-type-chart">
            <h3 class="chart-title">Fehler nach Typ</h3>
            <div class="chart-row">
              <span class="chart-row-label">Georef</span>
              <div class="chart-row-bar">
                <div class="chart-row-fill georef" style="width: 45%"></div>
              </div>
              <span class="chart-row-value">234</span>
            </div>
            <div class="chart-row">
              <span class="chart-row-label">GWR</span>
              <div class="chart-row-bar">
                <div class="chart-row-fill gwr" style="width: 30%"></div>
              </div>
              <span class="chart-row-value">156</span>
            </div>
            <div class="chart-row">
              <span class="chart-row-label">SAP</span>
              <div class="chart-row-bar">
                <div class="chart-row-fill sap" style="width: 17%"></div>
              </div>
              <span class="chart-row-value">89</span>
            </div>
            <div class="chart-row">
              <span class="chart-row-label">Adresse</span>
              <div class="chart-row-bar">
                <div class="chart-row-fill address" style="width: 9%"></div>
              </div>
              <span class="chart-row-value">45</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Einstellungen & Export Tab -->
    <div class="tab-content" id="tab-handbuch">
      <div class="handbuch-content">
        <!-- User Management Section -->
        <div class="handbuch-section">
          <h2 class="handbuch-section-title section-title-icon"><i data-lucide="users" class="icon-lg"></i> Benutzerverwaltung</h2>
          <div class="user-management">
            <div class="user-actions">
              <button class="action-btn primary" onclick="openModal('modal-invite-user')">
                <i data-lucide="user-plus" class="icon-sm"></i>
                Benutzer einladen
              </button>
            </div>
            <table class="users-table">
              <thead>
                <tr>
                  <th>Benutzer</th>
                  <th>Rolle</th>
                  <th>Status</th>
                  <th>Aktionen</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">MK</div>
                      <div class="user-details">
                        <span class="user-name">M. Keller</span>
                        <span class="user-email">m.keller@bbl.admin.ch</span>
                      </div>
                    </div>
                  </td>
                  <td><span class="badge badge-ok">Admin</span></td>
                  <td><span class="status-indicator active">Aktiv</span></td>
                  <td><button class="icon-btn" title="Bearbeiten"><i data-lucide="pencil" class="icon-sm"></i></button></td>
                </tr>
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">SB</div>
                      <div class="user-details">
                        <span class="user-name">S. Brunner</span>
                        <span class="user-email">s.brunner@bbl.admin.ch</span>
                      </div>
                    </div>
                  </td>
                  <td><span class="badge badge-warning">Bearbeiter</span></td>
                  <td><span class="status-indicator active">Aktiv</span></td>
                  <td>
                    <button class="icon-btn" title="Bearbeiten"><i data-lucide="pencil" class="icon-sm"></i></button>
                    <button class="icon-btn danger" title="Entfernen"><i data-lucide="trash-2" class="icon-sm"></i></button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">TW</div>
                      <div class="user-details">
                        <span class="user-name">T. Weber</span>
                        <span class="user-email">t.weber@bbl.admin.ch</span>
                      </div>
                    </div>
                  </td>
                  <td><span class="badge badge-warning">Bearbeiter</span></td>
                  <td><span class="status-indicator active">Aktiv</span></td>
                  <td>
                    <button class="icon-btn" title="Bearbeiten"><i data-lucide="pencil" class="icon-sm"></i></button>
                    <button class="icon-btn danger" title="Entfernen"><i data-lucide="trash-2" class="icon-sm"></i></button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="user-cell">
                      <div class="user-avatar">AM</div>
                      <div class="user-details">
                        <span class="user-name">A. Meier</span>
                        <span class="user-email">a.meier@bbl.admin.ch</span>
                      </div>
                    </div>
                  </td>
                  <td><span class="badge badge-georef">Leser</span></td>
                  <td><span class="status-indicator pending">Eingeladen</span></td>
                  <td>
                    <button class="icon-btn" title="Erneut einladen"><i data-lucide="mail" class="icon-sm"></i></button>
                    <button class="icon-btn danger" title="Entfernen"><i data-lucide="trash-2" class="icon-sm"></i></button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Export Section -->
        <div class="handbuch-section">
          <h2 class="handbuch-section-title section-title-icon"><i data-lucide="download" class="icon-lg"></i> Export</h2>
          <table class="downloads-table">
            <tr>
              <td class="download-name">Checkliste Vor-Ort-Prüfung</td>
              <td><span class="download-type pdf">PDF</span></td>
              <td><button class="download-btn">Download</button></td>
            </tr>
            <tr>
              <td class="download-name">Excel-Vorlage Massenkorrektur</td>
              <td><span class="download-type xlsx">XLSX</span></td>
              <td><button class="download-btn">Download</button></td>
            </tr>
            <tr>
              <td class="download-name">Aktueller Fehlerbericht</td>
              <td><span class="download-type csv">CSV</span></td>
              <td><button class="download-btn">Download</button></td>
            </tr>
            <tr>
              <td class="download-name">Meine offenen Aufgaben</td>
              <td><span class="download-type pdf">PDF</span></td>
              <td><button class="download-btn">Download</button></td>
            </tr>
          </table>
        </div>

        <div class="handbuch-section">
          <h2 class="handbuch-section-title section-title-icon"><i data-lucide="external-link" class="icon-lg"></i> Externe Ressourcen</h2>
          <ul class="external-links">
            <li class="external-link">
              <a href="#">• GWR Dokumentation (BFS) ↗</a>
            </li>
            <li class="external-link">
              <a href="#">• SAP RE-FX Handbuch (intern) ↗</a>
            </li>
            <li class="external-link">
              <a href="#">• swisstopo Koordinatensysteme ↗</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- Correction Modal -->
  <div class="modal-overlay" id="modal-correct">
    <div class="modal wide">
      <div class="modal-header">
        <h3 class="modal-title">Daten korrigieren</h3>
        <button class="modal-close" onclick="closeModal('modal-correct')">×</button>
      </div>
      <div class="modal-body">
        <div class="correction-compare">
          <div class="correction-source">
            <div class="correction-source-title">SAP RE-FX (Quelle)</div>
            <div class="correction-source-row">
              <span class="correction-source-label">Koordinaten:</span>
              <span class="mismatch">Fehlt</span>
            </div>
            <div class="correction-source-row">
              <span class="correction-source-label">Adresse:</span>
              <span>Friedrichshafnerstr.</span>
            </div>
            <div class="correction-source-row">
              <span class="correction-source-label">Baujahr:</span>
              <span>1965</span>
            </div>
          </div>
          <div class="correction-source">
            <div class="correction-source-title">GWR (Referenz)</div>
            <div class="correction-source-row">
              <span class="correction-source-label">Koordinaten:</span>
              <span class="match">✓ Vorhanden</span>
            </div>
            <div class="correction-source-row">
              <span class="correction-source-label">Adresse:</span>
              <span>Friedrichshafnerstr.</span>
            </div>
            <div class="correction-source-row">
              <span class="correction-source-label">Baujahr:</span>
              <span>1967</span>
            </div>
          </div>
        </div>

        <div class="correction-suggestion">
          <div class="correction-suggestion-title section-title-icon"><i data-lucide="lightbulb" class="icon"></i> Vorgeschlagene Aktion</div>
          <p class="correction-suggestion-text">Koordinaten aus GWR übernehmen nach SAP RE-FX</p>
          <button class="correction-apply-btn">Koordinaten übernehmen</button>
        </div>

        <label class="modal-label">Kommentar zur Korrektur:</label>
        <textarea class="modal-textarea" placeholder="Begründung der Korrektur..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal('modal-correct')">Abbrechen</button>
        <button class="modal-btn primary">Korrektur speichern</button>
      </div>
    </div>
  </div>

  <!-- Invite User Modal -->
  <div class="modal-overlay" id="modal-invite-user">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Benutzer einladen</h3>
        <button class="modal-close" onclick="closeModal('modal-invite-user')">×</button>
      </div>
      <div class="modal-body">
        <label class="modal-label">E-Mail-Adresse</label>
        <input type="email" class="modal-input" placeholder="name@bbl.admin.ch">

        <label class="modal-label">Rolle</label>
        <select class="modal-select">
          <option value="reader">Leser - Nur Ansicht</option>
          <option value="editor" selected>Bearbeiter - Kann Daten bearbeiten</option>
          <option value="admin">Admin - Voller Zugriff</option>
        </select>

        <label class="modal-label">Nachricht (optional)</label>
        <textarea class="modal-textarea" placeholder="Persönliche Nachricht zur Einladung..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal('modal-invite-user')">Abbrechen</button>
        <button class="modal-btn primary">Einladung senden</button>
      </div>
    </div>
  </div>

  <!-- Map Context Menu (Right-Click) -->
  <div id="map-context-menu" class="map-context-menu">
    <div class="context-menu-item context-menu-coords" id="context-menu-coords" title="Klicken zum Kopieren">
      <i data-lucide="copy" class="icon-sm"></i>
      <span id="context-menu-coords-text">47.37623, 8.53048</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="context-menu-share">
      <i data-lucide="share-2" class="icon-sm"></i>
      <span>Teilen</span>
    </div>
    <div class="context-menu-item" id="context-menu-center">
      <i data-lucide="crosshair" class="icon-sm"></i>
      <span>Hier zentrieren</span>
    </div>
    <div class="context-menu-item" id="context-menu-nearest">
      <i data-lucide="map-pin" class="icon-sm"></i>
      <span>Nächstes Objekt</span>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ========================================
    // Data (loaded from JSON files)
    // ========================================
    let teamMembers = [];
    let buildings = [];
    let events = [];
    let errors = {};
    let comments = {};

    async function loadData() {
      try {
        const [buildingsResponse, teamResponse, eventsResponse, errorsResponse, commentsResponse] = await Promise.all([
          fetch('data/buildings.json'),
          fetch('data/team.json'),
          fetch('data/events.json'),
          fetch('data/errors.json'),
          fetch('data/comments.json')
        ]);

        if (!buildingsResponse.ok || !teamResponse.ok || !eventsResponse.ok || !errorsResponse.ok || !commentsResponse.ok) {
          throw new Error('Failed to load data files');
        }

        buildings = await buildingsResponse.json();
        teamMembers = await teamResponse.json();
        events = await eventsResponse.json();
        errors = await errorsResponse.json();
        comments = await commentsResponse.json();

        // Merge errors and comments into buildings
        buildings.forEach(building => {
          building.errors = errors[building.id] || [];
          building.comments = comments[building.id] || [];
        });

        console.log(`Loaded ${buildings.length} buildings, ${teamMembers.length} team members, ${events.length} events, ${Object.keys(errors).length} error sets, ${Object.keys(comments).length} comment sets`);
      } catch (error) {
        console.error('Error loading data:', error);
        // Show error to user
        document.body.innerHTML = `
          <div class="error-container">
            <h1>Fehler beim Laden der Daten</h1>
            <p>Die Anwendung konnte die Daten nicht laden. Bitte stellen Sie sicher, dass die Anwendung über einen Webserver ausgeführt wird.</p>
            <code>${error.message}</code>
          </div>
        `;
        throw error;
      }
    }

    // ========================================
    // State
    // ========================================
    let state = {
      selectedBuildingId: null,
      activeFilters: {
        high: true,
        medium: true,
        low: true,
        myTasks: false
      },
      filterKanton: [],      // Empty array = show all
      filterConfidence: [],  // Empty array = show all
      filterPortfolio: [],   // Empty array = show all
      filterAssignee: [],    // Empty array = show all
      currentTab: 'karte'
    };

    let map;
    let markers = {};

    // ========================================
    // URL Navigation
    // ========================================
    function updateURL(replace = false) {
      const params = new URLSearchParams();

      // Add current tab
      params.set('tab', state.currentTab);

      // Add selected building if any
      if (state.selectedBuildingId) {
        params.set('id', state.selectedBuildingId);
      }

      // Add active filters (only non-default values)
      const defaultFilters = { high: true, medium: true, low: true, myTasks: false };
      const filterDiff = [];
      Object.entries(state.activeFilters).forEach(([key, value]) => {
        if (value !== defaultFilters[key]) {
          filterDiff.push(value ? key : `-${key}`);
        }
      });
      if (filterDiff.length > 0) {
        params.set('filters', filterDiff.join(','));
      }

      // Add dropdown filters
      if (state.filterKanton.length > 0) params.set('kanton', state.filterKanton.join(','));
      if (state.filterConfidence.length > 0) params.set('confidence', state.filterConfidence.join(','));
      if (state.filterPortfolio.length > 0) params.set('portfolio', state.filterPortfolio.join(','));
      if (state.filterAssignee.length > 0) params.set('assignee', state.filterAssignee.join(','));

      // Add table visibility (only add param if hidden, since visible is default)
      if (!tableVisible) params.set('table', '0');

      // Update URL without page reload
      const newURL = `${window.location.pathname}?${params.toString()}`;
      if (replace) {
        window.history.replaceState({ ...state, tableVisible }, '', newURL);
      } else {
        window.history.pushState({ ...state, tableVisible }, '', newURL);
      }
    }

    function parseURL() {
      const params = new URLSearchParams(window.location.search);

      // Parse tab
      const tab = params.get('tab');
      if (tab && ['karte', 'aufgaben', 'statistik', 'handbuch'].includes(tab)) {
        state.currentTab = tab;
      }

      // Parse selected building
      const buildingId = params.get('id');
      if (buildingId) {
        state.selectedBuildingId = buildingId;
      }

      // Parse filters
      const filters = params.get('filters');
      if (filters) {
        filters.split(',').forEach(filter => {
          if (filter.startsWith('-')) {
            const key = filter.substring(1);
            if (state.activeFilters.hasOwnProperty(key)) {
              state.activeFilters[key] = false;
            }
          } else if (filter === 'myTasks') {
            state.activeFilters.myTasks = true;
          } else if (state.activeFilters.hasOwnProperty(filter)) {
            state.activeFilters[filter] = true;
          }
        });
      }

      // Parse dropdown filters (comma-separated values, empty = show all)
      const kantonParam = params.get('kanton');
      const confidenceParam = params.get('confidence');
      const portfolioParam = params.get('portfolio');
      const assigneeParam = params.get('assignee');
      state.filterKanton = kantonParam ? kantonParam.split(',') : [];
      state.filterConfidence = confidenceParam ? confidenceParam.split(',') : [];
      state.filterPortfolio = portfolioParam ? portfolioParam.split(',') : [];
      state.filterAssignee = assigneeParam ? assigneeParam.split(',') : [];

      // Return table visibility (default is visible, so check for explicit hide)
      return params.get('table') !== '0';
    }

    function applyURLState() {
      const shouldShowTable = parseURL();

      // Apply tab UI
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === state.currentTab);
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${state.currentTab}`);
      });

      // Apply filters UI
      document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
        const filterName = chip.dataset.filter;
        if (filterName === 'my-tasks') {
          chip.classList.toggle('active', state.activeFilters.myTasks);
        } else if (state.activeFilters.hasOwnProperty(filterName)) {
          chip.classList.toggle('active', state.activeFilters[filterName]);
        }
      });

      // Apply multi-select filter checkboxes
      applyMultiSelectState('filter-kanton', state.filterKanton);
      applyMultiSelectState('filter-confidence', state.filterConfidence);
      applyMultiSelectState('filter-portfolio', state.filterPortfolio);
      applyMultiSelectState('filter-assignee', state.filterAssignee);

      // Apply table visibility (default is visible)
      tableVisible = shouldShowTable;
      document.getElementById('table-panel').classList.toggle('visible', tableVisible);
      document.getElementById('table-toggle-btn').classList.toggle('active', tableVisible);

      // Set initial URL state (replace to not add to history)
      updateURL(true);
    }

    function handlePopState(event) {
      if (event.state) {
        // Restore state from history
        state.currentTab = event.state.currentTab || 'karte';
        state.selectedBuildingId = event.state.selectedBuildingId || null;
        state.activeFilters = event.state.activeFilters || { high: true, medium: true, low: true, myTasks: false };
        state.filterKanton = event.state.filterKanton || [];
        state.filterConfidence = event.state.filterConfidence || [];
        state.filterPortfolio = event.state.filterPortfolio || [];
        state.filterAssignee = event.state.filterAssignee || [];
        tableVisible = event.state.tableVisible !== undefined ? event.state.tableVisible : true;

        // Apply tab
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === state.currentTab);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('active', content.id === `tab-${state.currentTab}`);
        });

        // Update filter chips UI
        document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
          const filterName = chip.dataset.filter;
          if (filterName === 'my-tasks') {
            chip.classList.toggle('active', state.activeFilters.myTasks);
          } else if (state.activeFilters.hasOwnProperty(filterName)) {
            chip.classList.toggle('active', state.activeFilters[filterName]);
          }
        });

        // Update multi-select dropdowns
        applyMultiSelectState('filter-kanton', state.filterKanton);
        applyMultiSelectState('filter-confidence', state.filterConfidence);
        applyMultiSelectState('filter-portfolio', state.filterPortfolio);
        applyMultiSelectState('filter-assignee', state.filterAssignee);

        // Update table visibility
        document.getElementById('table-panel').classList.toggle('visible', tableVisible);
        document.getElementById('table-toggle-btn').classList.toggle('active', tableVisible);

        // Render views
        updateMapMarkers();
        updateCounts();

        if (state.selectedBuildingId) {
          const building = buildings.find(b => b.id === state.selectedBuildingId);
          if (building) {
            // Update list selection
            document.querySelectorAll('.list-item').forEach(item => {
              item.classList.toggle('selected', item.dataset.id === state.selectedBuildingId);
            });
            // Update map
            Object.entries(markers).forEach(([markerId, marker]) => {
              const isSelected = markerId === state.selectedBuildingId;
              const markerBuilding = buildings.find(b => b.id === markerId);
              marker.setIcon(L.divIcon({
                className: 'custom-marker-container',
                html: `<div class="custom-marker ${markerBuilding.priority} ${isSelected ? 'selected' : ''}" data-id="${markerId}"></div>`,
                iconSize: isSelected ? [24, 24] : [16, 16],
                iconAnchor: isSelected ? [12, 12] : [8, 8]
              }));
            });
            map.setView([building.lat, building.lng], 12);
            renderDetailPanel(building);
          }
        } else {
          renderDetailPanel(null);
        }

        if (tableVisible) renderTableView();

        // Resize map if on karte tab
        if (state.currentTab === 'karte') {
          setTimeout(() => map.invalidateSize(), 100);
        }
      }
    }

    // ========================================
    // Initialization
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Load data from JSON files
      await loadData();

      initMap();

      // Parse URL and apply initial state
      applyURLState();

      renderKanbanBoard();
      setupEventListeners();
      setupTableViewListeners();
      setupExpandingSearch();
      setupFilterToggle();
      setupTableResize();
      setupBasemapSelector();
      setupContextMenu();
      setupAccordions();
      updateCounts();

      // Apply building selection from URL after rendering
      if (state.selectedBuildingId) {
        selectBuilding(state.selectedBuildingId, false);
      }

      // Render table if visible
      if (tableVisible) renderTableView();

      // Listen for browser back/forward
      window.addEventListener('popstate', handlePopState);
    });

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([47.0, 8.3], 8);

      // Add zoom control to top-right
      L.control.zoom({ position: 'topright' }).addTo(map);

      // Initialize with default basemap (color)
      switchBasemapTiles(currentBasemap);

      buildings.forEach(building => {
        const marker = createMarker(building);
        markers[building.id] = marker;
        marker.addTo(map);
      });
    }

    function createMarker(building) {
      const icon = L.divIcon({
        className: 'custom-marker-container',
        html: `<div class="custom-marker ${building.priority}" data-id="${building.id}"></div>`,
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });

      const marker = L.marker([building.lat, building.lng], { icon });
      marker.on('click', () => selectBuilding(building.id));
      return marker;
    }

    // ========================================
    // Rendering Functions
    // ========================================
    function renderDetailPanel(building) {
      const detailPanel = document.getElementById('detail-panel');
      const wasVisible = detailPanel.classList.contains('visible');

      if (!building) {
        detailPanel.classList.remove('visible');
        // Resize map after panel hides
        if (wasVisible && map) {
          setTimeout(() => map.invalidateSize(), 10);
        }
        return;
      }

      detailPanel.classList.add('visible');
      // Resize map after panel shows
      if (!wasVisible && map) {
        setTimeout(() => map.invalidateSize(), 10);
      }

      document.getElementById('detail-title').textContent = building.name;
      document.getElementById('detail-sap-id').textContent = building.id;

      // Confidence
      const totalClass = building.confidence.total < 50 ? 'critical' :
                         building.confidence.total < 80 ? 'warning' : 'ok';
      document.getElementById('confidence-total').textContent = building.confidence.total + '%';
      document.getElementById('confidence-total').className = 'confidence-total ' + totalClass;

      ['georef', 'sap', 'gwr'].forEach(key => {
        const val = building.confidence[key];
        const barClass = val < 50 ? 'critical' : val < 80 ? 'warning' : 'ok';
        document.getElementById(`bar-${key}`).style.width = val + '%';
        document.getElementById(`bar-${key}`).className = 'confidence-bar-fill ' + barClass;
        document.getElementById(`val-${key}`).textContent = val + '%';
      });

      // Errors
      document.getElementById('error-cards').innerHTML = building.errors.length > 0
        ? building.errors.map(error => `
            <div class="error-card ${error.severity}">
              <div class="error-card-header">
                <span class="badge badge-${error.type} badge-caps badge-sm">${getTagLabel(error.type)}</span>
                <span class="error-card-title">${error.title}</span>
              </div>
              <div class="error-card-desc">${error.description}</div>
            </div>
          `).join('')
        : '<p class="empty-text">Keine Fehler gefunden.</p>';

      // Update error count badge and auto-expand if errors
      const errorCountEl = document.getElementById('error-count');
      const fehlerAccordion = document.querySelector('[data-accordion="fehler"]');
      if (building.errors.length > 0) {
        errorCountEl.textContent = building.errors.length;
        errorCountEl.style.display = '';
        // Auto-expand errors section when there are errors
        fehlerAccordion.classList.add('open');
      } else {
        errorCountEl.style.display = 'none';
        fehlerAccordion.classList.remove('open');
      }

      // Data comparison
      document.getElementById('data-comparison').innerHTML = Object.entries(building.data).map(([key, val]) => `
        <tr>
          <td>${getDataLabel(key)}</td>
          <td class="${val.match ? 'match' : (val.sap === 'Fehlt' || val.sap === '—' ? 'missing' : 'mismatch')}">${val.sap}</td>
          <td class="${val.match ? 'match' : (val.gwr === '—' ? 'missing' : 'mismatch')}">${val.gwr}</td>
        </tr>
      `).join('');

      // Comments
      document.getElementById('comments-list').innerHTML = building.comments.length > 0
        ? building.comments.map(comment => `
            <div class="comment ${comment.system ? 'system' : ''}">
              <div class="comment-header">
                <span class="comment-author">${comment.author}</span>
                <span class="comment-date">${comment.date}</span>
              </div>
              <div class="comment-text">${comment.text}</div>
            </div>
          `).join('')
        : '<p class="empty-text">Keine Kommentare.</p>';

      // Update comments count badge
      const commentsCountEl = document.getElementById('comments-count');
      if (building.comments.length > 0) {
        commentsCountEl.textContent = building.comments.length;
        commentsCountEl.style.display = '';
      } else {
        commentsCountEl.style.display = 'none';
      }

      // Assignee
      renderAssigneeDisplay(building);

      // Events
      renderEventsLog(building.id);

      // Refresh Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function renderAssigneeDisplay(building) {
      const container = document.getElementById('assignee-display');
      const currentAssignee = building.assignee;
      const member = currentAssignee ? teamMembers.find(m => m.name === currentAssignee) : null;

      // Build trigger content
      let triggerContent;
      if (currentAssignee) {
        const initials = member ? member.initials : currentAssignee.split(' ').map(n => n[0]).join('');
        const role = member ? member.role : '';
        triggerContent = `
          <div class="assignee-avatar">${initials}</div>
          <div class="assignee-info">
            <div class="assignee-name">${currentAssignee}</div>
            ${role ? `<div class="assignee-role">${role}</div>` : ''}
          </div>
        `;
      } else {
        triggerContent = `
          <div class="assignee-avatar empty"><i data-lucide="user" class="icon-sm"></i></div>
          <div class="assignee-info">
            <span class="assignee-empty-text">Zuweisen...</span>
          </div>
        `;
      }

      // Build dropdown options
      const options = teamMembers.map(m => `
        <button class="assignee-option ${currentAssignee === m.name ? 'selected' : ''}" data-assignee="${m.name}">
          <div class="assignee-avatar">${m.initials}</div>
          <div class="assignee-option-info">
            <div class="assignee-option-name">${m.name}</div>
            <div class="assignee-option-role">${m.role}</div>
          </div>
          <i data-lucide="check" class="icon-sm assignee-option-check"></i>
        </button>
      `).join('');

      // Add unassign option if currently assigned
      const unassignOption = currentAssignee ? `
        <div class="assignee-divider"></div>
        <button class="assignee-option unassign" data-assignee="">
          <div class="assignee-avatar empty"><i data-lucide="user-minus" class="icon-sm"></i></div>
          <div class="assignee-option-info">
            <div class="assignee-option-name">Zuweisung aufheben</div>
          </div>
        </button>
      ` : '';

      container.innerHTML = `
        <button class="assignee-trigger" type="button">
          ${triggerContent}
          <i data-lucide="chevron-down" class="icon-sm assignee-chevron"></i>
        </button>
        <div class="assignee-dropdown">
          ${options}
          ${unassignOption}
        </div>
      `;

      // Setup event listeners
      const trigger = container.querySelector('.assignee-trigger');
      const dropdown = container.querySelector('.assignee-dropdown');

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        container.classList.toggle('open');
      });

      // Handle option selection
      container.querySelectorAll('.assignee-option').forEach(option => {
        option.addEventListener('click', () => {
          const newAssignee = option.dataset.assignee || null;
          assignBuilding(building.id, newAssignee);
          container.classList.remove('open');
        });
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          container.classList.remove('open');
        }
      }, { once: true });

      // Refresh Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function assignBuilding(buildingId, assigneeName) {
      // Find building and update
      const building = buildings.find(b => b.id === buildingId);
      if (building) {
        building.assignee = assigneeName;
        building.lastUpdate = new Date().toISOString();
        building.lastUpdateBy = 'M. Keller'; // Current user

        // Re-render
        renderAssigneeDisplay(building);
        renderKanbanBoard();
        if (tableVisible) renderTableView();
        updateCounts();
      }
    }

    function renderEventsLog(buildingId) {
      const container = document.getElementById('events-list');
      const eventsCountEl = document.getElementById('events-count');
      const buildingEvents = events
        .filter(e => e.buildingId === buildingId)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Update events count badge
      if (buildingEvents.length > 0) {
        eventsCountEl.textContent = buildingEvents.length;
        eventsCountEl.style.display = '';
      } else {
        eventsCountEl.style.display = 'none';
      }

      if (buildingEvents.length === 0) {
        container.innerHTML = '<p class="empty-text">Keine Ereignisse.</p>';
        return;
      }

      container.innerHTML = buildingEvents.map(event => `
        <div class="event-item">
          <div class="event-icon ${event.type}">
            ${getEventIcon(event.type)}
          </div>
          <div class="event-content">
            <div class="event-header">
              <span class="event-action">${event.action}</span>
              <span class="event-time">${formatEventTime(event.timestamp)}</span>
            </div>
            <div class="event-details">${event.details}</div>
            <div class="event-user">von ${event.user}</div>
          </div>
        </div>
      `).join('');
    }

    function getEventIcon(type) {
      const icons = {
        assignment: '<i data-lucide="user-plus" class="icon-sm"></i>',
        comment: '<i data-lucide="message-square" class="icon-sm"></i>',
        status: '<i data-lucide="refresh-cw" class="icon-sm"></i>',
        correction: '<i data-lucide="check-circle" class="icon-sm"></i>',
        detection: '<i data-lucide="alert-triangle" class="icon-sm"></i>'
      };
      return icons[type] || '<i data-lucide="circle" class="icon-sm"></i>';
    }

    function formatEventTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) {
        return date.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
      } else if (diffDays === 1) {
        return 'Gestern';
      } else if (diffDays < 7) {
        return `vor ${diffDays} Tagen`;
      } else {
        return date.toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }
    }

    function renderKanbanBoard() {
      const columns = {
        open: buildings.filter(b => b.kanbanStatus === 'open'),
        assigned: buildings.filter(b => b.kanbanStatus === 'assigned'),
        review: buildings.filter(b => b.kanbanStatus === 'review'),
        done: buildings.filter(b => b.kanbanStatus === 'done')
      };

      Object.entries(columns).forEach(([status, items]) => {
        const container = document.getElementById(`kanban-${status}`);
        const displayItems = items.slice(0, 3);

        container.innerHTML = displayItems.map(building => `
          <div class="kanban-card ${building.priority}" onclick="selectBuildingAndSwitch('${building.id}')">
            <div class="kanban-card-name">${building.name}</div>
            <div class="kanban-card-sap-id">${building.id}</div>
            <div class="badge-group">
              ${building.errors.map(err => `<span class="badge badge-${err.type} badge-caps badge-sm">${getTagLabel(err.type)}</span>`).join('')}
            </div>
            <div class="kanban-card-meta">
              <span>${building.assignee || 'Nicht zugewiesen'}</span>
              <span class="meta-icon" title="${formatDateTime(building.lastUpdate)} von ${building.lastUpdateBy || '—'}"><i data-lucide="clock" class="icon-sm"></i> ${formatRelativeTime(building.lastUpdate)}</span>
            </div>
          </div>
        `).join('');

        if (items.length > 3) {
          container.innerHTML += `<div class="kanban-more">+${items.length - 3} mehr</div>`;
        }

        document.getElementById(`kanban-${status}-count`).textContent = items.length;
      });

      // Re-initialize Lucide icons for dynamically added content
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    // ========================================
    // Event Handlers
    // ========================================
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Detail panel close button
      document.getElementById('detail-close-btn').addEventListener('click', () => {
        state.selectedBuildingId = null;
        renderDetailPanel(null);
        // Deselect marker
        Object.values(markers).forEach(m => m.getElement()?.classList.remove('selected'));
        updateURL();
      });

      // Filter chips
      document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
        chip.addEventListener('click', () => toggleFilter(chip.dataset.filter));
      });

      // Multi-select filter dropdowns
      setupMultiSelectFilter('filter-kanton', 'filterKanton');
      setupMultiSelectFilter('filter-confidence', 'filterConfidence');
      setupMultiSelectFilter('filter-portfolio', 'filterPortfolio');
      setupMultiSelectFilter('filter-assignee', 'filterAssignee');

      // Basemap selector
      document.querySelectorAll('.basemap-btn').forEach(btn => {
        btn.addEventListener('click', () => switchBasemap(btn.dataset.basemap));
      });

      // Action buttons
      document.getElementById('btn-correct').addEventListener('click', () => openModal('modal-correct'));

      // Global search
      document.getElementById('globalSearch').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        filterBySearch(query);
      });

      // Close modals on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
          });
        }
      });

      // Close modals on backdrop click
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });

      // Comment input handlers
      document.getElementById('btn-submit-comment').addEventListener('click', submitComment);
      document.getElementById('btn-cancel-comment').addEventListener('click', cancelComment);
      document.getElementById('comment-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          submitComment();
        }
      });
    }

    function submitComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (!text || !state.selectedBuildingId) return;

      const building = buildings.find(b => b.id === state.selectedBuildingId);
      if (!building) return;

      // Add new comment
      const newComment = {
        author: 'M. Keller',
        date: new Date().toLocaleDateString('de-CH'),
        text: text,
        system: false
      };
      building.comments.push(newComment);
      building.lastUpdate = new Date().toISOString();
      building.lastUpdateBy = 'M. Keller';

      // Clear input and re-render
      input.value = '';
      renderDetailPanel(building);
    }

    function cancelComment() {
      document.getElementById('comment-input').value = '';
    }

    function switchTab(tabId, shouldUpdateURL = true) {
      state.currentTab = tabId;

      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });

      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabId}`);
      });

      if (tabId === 'karte') {
        setTimeout(() => map.invalidateSize(), 100);
      }

      if (shouldUpdateURL) updateURL();
    }

    function selectBuilding(id, shouldUpdateURL = true) {
      state.selectedBuildingId = id;
      const building = buildings.find(b => b.id === id);

      // Update list selection
      document.querySelectorAll('.list-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.id === id);
      });

      // Update map marker
      Object.entries(markers).forEach(([markerId, marker]) => {
        const isSelected = markerId === id;
        const markerBuilding = buildings.find(b => b.id === markerId);
        marker.setIcon(L.divIcon({
          className: 'custom-marker-container',
          html: `<div class="custom-marker ${markerBuilding.priority} ${isSelected ? 'selected' : ''}" data-id="${markerId}"></div>`,
          iconSize: isSelected ? [24, 24] : [16, 16],
          iconAnchor: isSelected ? [12, 12] : [8, 8]
        }));
      });

      // Center map on selected building
      if (building) {
        map.setView([building.lat, building.lng], 12);
      }

      // Update detail panel
      renderDetailPanel(building);

      // Update table view if visible
      if (tableVisible) renderTableView();

      if (shouldUpdateURL) updateURL();
    }

    function selectBuildingAndSwitch(id) {
      switchTab('karte');
      setTimeout(() => selectBuilding(id), 100);
    }

    function toggleFilter(filterName, shouldUpdateURL = true) {
      if (filterName === 'my-tasks') {
        state.activeFilters.myTasks = !state.activeFilters.myTasks;
      } else {
        state.activeFilters[filterName] = !state.activeFilters[filterName];
      }

      document.querySelectorAll(`.filter-chip[data-filter="${filterName}"]`).forEach(chip => {
        chip.classList.toggle('active', state.activeFilters[filterName] ||
          (filterName === 'my-tasks' && state.activeFilters.myTasks));
      });

      applyFilters(shouldUpdateURL);
    }

    function setupMultiSelectFilter(elementId, stateKey) {
      const container = document.getElementById(elementId);
      const trigger = container.querySelector('.multi-select-trigger');
      const dropdown = container.querySelector('.multi-select-dropdown');
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const allBtn = container.querySelector('[data-action="all"]');
      const noneBtn = container.querySelector('[data-action="none"]');
      const label = container.querySelector('.multi-select-label');

      // Toggle dropdown
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.multi-select.open').forEach(el => {
          if (el !== container) el.classList.remove('open');
        });
        container.classList.toggle('open');
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          container.classList.remove('open');
        }
      });

      // Checkbox change
      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          updateMultiSelectState();
        });
      });

      // Select all
      allBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = true);
        updateMultiSelectState();
      });

      // Select none
      noneBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = false);
        updateMultiSelectState();
      });

      function updateMultiSelectState() {
        const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        state[stateKey] = selected.length === checkboxes.length ? [] : selected;
        updateLabel();
        applyFilters();
      }

      function updateLabel() {
        const selected = Array.from(checkboxes).filter(cb => cb.checked);
        if (selected.length === 0) {
          label.textContent = label.dataset.default || elementId.replace('filter-', '');
          label.classList.add('none-selected');
        } else if (selected.length === checkboxes.length) {
          label.textContent = label.dataset.default || elementId.replace('filter-', '');
          label.classList.remove('none-selected');
        } else if (selected.length === 1) {
          label.textContent = selected[0].nextElementSibling.textContent;
          label.classList.remove('none-selected');
        } else {
          label.textContent = `${selected.length} ausgewählt`;
          label.classList.remove('none-selected');
        }
      }

      // Initialize: all checked by default
      checkboxes.forEach(cb => cb.checked = true);
      label.dataset.default = label.textContent;
    }

    function applyMultiSelectState(elementId, selectedValues) {
      const container = document.getElementById(elementId);
      if (!container) return;

      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const label = container.querySelector('.multi-select-label');

      // If empty array, check all (show all)
      if (selectedValues.length === 0) {
        checkboxes.forEach(cb => cb.checked = true);
        if (label && label.dataset.default) {
          label.textContent = label.dataset.default;
        }
      } else {
        // Check only selected values
        checkboxes.forEach(cb => {
          cb.checked = selectedValues.includes(cb.value);
        });
        // Update label
        if (label) {
          const checkedCount = selectedValues.length;
          if (checkedCount === 1) {
            const cb = Array.from(checkboxes).find(cb => cb.value === selectedValues[0]);
            label.textContent = cb ? cb.nextElementSibling.textContent : selectedValues[0];
          } else {
            label.textContent = `${checkedCount} ausgewählt`;
          }
        }
      }
    }

    function applyFilters(shouldUpdateURL = true) {
      updateMapMarkers();
      updateCounts();
      if (tableVisible) renderTableView();
      if (shouldUpdateURL) updateURL();
    }

    function getFilteredBuildings() {
      return buildings.filter(building => {
        // Search filter
        if (searchQuery) {
          const matchesSearch = building.name.toLowerCase().includes(searchQuery) ||
                                building.id.toLowerCase().includes(searchQuery);
          if (!matchesSearch) return false;
        }

        // Priority filters
        if (!state.activeFilters[building.priority]) {
          return false;
        }

        // My tasks filter
        if (state.activeFilters.myTasks && building.assignee !== 'M. Keller') {
          return false;
        }

        // Kanton filter (empty array = show all)
        if (state.filterKanton.length > 0 && !state.filterKanton.includes(building.kanton)) {
          return false;
        }

        // Confidence filter (empty array = show all)
        if (state.filterConfidence.length > 0) {
          const conf = building.confidence.total;
          const confLevel = conf < 50 ? 'critical' : conf < 80 ? 'warning' : 'ok';
          if (!state.filterConfidence.includes(confLevel)) return false;
        }

        // Portfolio filter (empty array = show all)
        if (state.filterPortfolio.length > 0 && !state.filterPortfolio.includes(building.portfolio)) {
          return false;
        }

        // Assignee filter (empty array = show all, empty string matches unassigned)
        if (state.filterAssignee.length > 0) {
          const assignee = building.assignee || '';
          if (!state.filterAssignee.includes(assignee)) return false;
        }

        return true;
      });
    }

    function updateMapMarkers() {
      const filteredIds = new Set(getFilteredBuildings().map(b => b.id));

      Object.entries(markers).forEach(([id, marker]) => {
        if (filteredIds.has(id)) {
          marker.addTo(map);
        } else {
          marker.remove();
        }
      });
    }

    function updateCounts() {
      const counts = { high: 0, medium: 0, low: 0 };
      buildings.forEach(b => {
        if (counts[b.priority] !== undefined) counts[b.priority]++;
      });

      Object.entries(counts).forEach(([priority, count]) => {
        const el = document.getElementById(`count-${priority}`);
        if (el) el.textContent = `(${count})`;
      });
    }

    function switchBasemap(basemap) {
      document.querySelectorAll('.basemap-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.basemap === basemap);
      });

      // In a real app, you would switch tile layers here
      // For the prototype, we just update the active state
    }

    // Search state
    let searchQuery = '';

    function filterBySearch(query) {
      searchQuery = query.toLowerCase();

      // Update map markers based on search
      const filtered = getFilteredBuildings();
      const filteredIds = new Set(filtered.map(b => b.id));

      Object.entries(markers).forEach(([id, marker]) => {
        if (filteredIds.has(id)) {
          marker.addTo(map);
        } else {
          marker.remove();
        }
      });

      // Update table view
      if (tableVisible) renderTableView();
    }

    // ========================================
    // Modal Functions
    // ========================================
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ========================================
    // Handbuch Functions
    // ========================================
    function toggleDocItem(element) {
      const item = element.closest('.doc-item');
      const children = item.querySelector('.doc-children');
      const icon = element.querySelector('.doc-item-icon');

      if (children) {
        children.classList.toggle('expanded');
        icon.textContent = children.classList.contains('expanded') ? '▾' : '▸';
      }
    }

    // ========================================
    // Utility Functions
    // ========================================
    function getTagLabel(tag) {
      const labels = {
        georef: 'Georef',
        sap: 'SAP',
        gwr: 'GWR',
        address: 'Adresse'
      };
      return labels[tag] || tag;
    }

    function getDataLabel(key) {
      const labels = {
        address: 'Adresse',
        plz: 'PLZ',
        coords: 'Koordinaten (WGS 84)',
        egid: 'EGID',
        year: 'Baujahr'
      };
      return labels[key] || key;
    }

    function formatRelativeTime(isoString) {
      if (!isoString) return '—';
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Gerade eben';
      if (diffMins < 60) return `vor ${diffMins} Min.`;
      if (diffHours < 24) return `vor ${diffHours} Std.`;
      if (diffDays === 1) return 'Gestern';
      if (diffDays < 7) return `vor ${diffDays} Tagen`;
      if (diffDays < 30) return `vor ${Math.floor(diffDays / 7)} Wochen`;
      return date.toLocaleDateString('de-CH');
    }

    function formatDateTime(isoString) {
      if (!isoString) return '—';
      const date = new Date(isoString);
      return date.toLocaleString('de-CH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ========================================
    // Table View Functions
    // ========================================
    let tableVisible = true;

    function toggleTableView() {
      tableVisible = !tableVisible;
      const tablePanel = document.getElementById('table-panel');
      const toggleBtn = document.getElementById('table-toggle-btn');

      if (tableVisible) {
        tablePanel.classList.add('visible');
        toggleBtn.classList.add('active');
        renderTableView();
        // Resize map after table is shown
        setTimeout(() => map.invalidateSize(), 100);
      } else {
        tablePanel.classList.remove('visible');
        toggleBtn.classList.remove('active');
        // Resize map after table is hidden
        setTimeout(() => map.invalidateSize(), 100);
      }

      updateURL();
    }

    function closeTableView() {
      tableVisible = false;
      document.getElementById('table-panel').classList.remove('visible');
      document.getElementById('table-toggle-btn').classList.remove('active');
      setTimeout(() => map.invalidateSize(), 100);
      updateURL();
    }

    function renderTableView() {
      const filteredBuildings = getFilteredBuildings();
      const tbody = document.getElementById('table-body');

      const priorityConfig = {
        high: { label: 'Hoch', badge: 'badge-critical' },
        medium: { label: 'Mittel', badge: 'badge-warning' },
        low: { label: 'Niedrig', badge: 'badge-ok' }
      };

      tbody.innerHTML = filteredBuildings.map(building => {
        const priority = priorityConfig[building.priority] || { label: building.priority, badge: '' };
        return `
        <tr class="${state.selectedBuildingId === building.id ? 'selected' : ''}"
            onclick="selectBuilding('${building.id}')">
          <td>
            <span class="badge ${priority.badge}">${priority.label}</span>
          </td>
          <td><code class="sap-id">${building.id}</code></td>
          <td class="cell-name">${building.name}</td>
          <td>${building.kanton}</td>
          <td>
            <span class="confidence-value ${building.confidence.total < 50 ? 'critical' : building.confidence.total < 80 ? 'warning' : 'ok'}">
              ${building.confidence.total}%
            </span>
          </td>
          <td>
            <div class="badge-group">
              ${building.errors.map(err => `<span class="badge badge-${err.type} badge-caps badge-sm">${getTagLabel(err.type)}</span>`).join('')}
              ${building.errors.length === 0 ? '<span class="text-muted">—</span>' : ''}
            </div>
          </td>
          <td>${building.assignee ? `<span class="text-secondary">${building.assignee}</span>` : '<span class="text-muted">—</span>'}</td>
          <td class="text-muted" title="${formatDateTime(building.lastUpdate)} von ${building.lastUpdateBy || '—'}">${formatRelativeTime(building.lastUpdate)}</td>
        </tr>
      `}).join('');

      document.getElementById('table-count').textContent = `(${filteredBuildings.length})`;
    }

    // Setup table view event listeners
    function setupTableViewListeners() {
      document.getElementById('table-toggle-btn').addEventListener('click', toggleTableView);
      document.getElementById('table-close-btn').addEventListener('click', closeTableView);
    }

    // ========================================
    // Expanding Search Bar
    // ========================================
    function setupExpandingSearch() {
      const searchContainer = document.getElementById('search-container');
      const searchToggle = document.getElementById('search-toggle');
      const searchInput = document.getElementById('globalSearch');

      searchToggle.addEventListener('click', () => {
        searchContainer.classList.add('expanded');
        searchInput.focus();
      });

      searchInput.addEventListener('blur', () => {
        // Collapse if empty
        if (!searchInput.value.trim()) {
          searchContainer.classList.remove('expanded');
        }
      });

      // Handle Escape to close
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchInput.value = '';
          searchInput.blur();
          searchContainer.classList.remove('expanded');
          filterBySearch('');
        }
      });
    }

    // ========================================
    // Filter Bar Toggle
    // ========================================
    let filterBarVisible = true;

    function setupFilterToggle() {
      const filterToggle = document.getElementById('filter-toggle');
      const filterBar = document.getElementById('filter-bar');

      filterToggle.addEventListener('click', () => {
        filterBarVisible = !filterBarVisible;
        filterBar.classList.toggle('hidden', !filterBarVisible);
        filterToggle.classList.toggle('active', filterBarVisible);
      });
    }

    // ========================================
    // Basemap Selector
    // ========================================
    let currentBasemap = 'color';
    let basemapLayer = null;

    const basemapConfigs = {
      none: {
        url: null,
        attribution: ''
      },
      grey: {
        url: 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
        attribution: '© OpenStreetMap © CARTO'
      },
      color: {
        url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
        attribution: '© OpenStreetMap © CARTO'
      },
      satellite: {
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        attribution: '© Esri, Maxar, Earthstar Geographics'
      }
    };

    function switchBasemapTiles(basemapId) {
      const config = basemapConfigs[basemapId];

      // Remove existing basemap layer
      if (basemapLayer) {
        map.removeLayer(basemapLayer);
        basemapLayer = null;
      }

      // Add new basemap layer if not 'none'
      if (config.url) {
        basemapLayer = L.tileLayer(config.url, {
          attribution: config.attribution,
          maxZoom: 19
        });
        basemapLayer.addTo(map);
        basemapLayer.bringToBack();
      }
    }

    function setupBasemapSelector() {
      const selector = document.getElementById('basemap-selector');
      const trigger = document.getElementById('basemap-trigger');
      const triggerThumb = document.getElementById('basemap-trigger-thumb');
      const panel = document.getElementById('basemap-panel');
      const options = document.querySelectorAll('.basemap-option');

      // Toggle panel on trigger click
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        selector.classList.toggle('expanded');
      });

      // Handle option selection
      options.forEach(option => {
        option.addEventListener('click', () => {
          const basemap = option.dataset.basemap;
          currentBasemap = basemap;

          // Update active state
          options.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');

          // Update trigger thumbnail to show current basemap
          triggerThumb.className = 'basemap-thumb basemap-' + basemap;

          // Switch the actual map tiles
          switchBasemapTiles(basemap);

          // Collapse the panel
          selector.classList.remove('expanded');
        });
      });

      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        if (!selector.contains(e.target)) {
          selector.classList.remove('expanded');
        }
      });

      // Close panel on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          selector.classList.remove('expanded');
        }
      });
    }

    // ========================================
    // Table Panel Resize
    // ========================================
    function setupTableResize() {
      const resizeHandle = document.getElementById('table-resize-handle');
      const tablePanel = document.getElementById('table-panel');
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      resizeHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = tablePanel.offsetHeight;
        resizeHandle.classList.add('dragging');
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const deltaY = startY - e.clientY;
        const newHeight = Math.min(Math.max(startHeight + deltaY, 100), window.innerHeight * 0.7);
        tablePanel.style.height = newHeight + 'px';

        // Resize map to fit
        map.invalidateSize();
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          resizeHandle.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Touch support
      resizeHandle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startY = e.touches[0].clientY;
        startHeight = tablePanel.offsetHeight;
        resizeHandle.classList.add('dragging');
        e.preventDefault();
      });

      document.addEventListener('touchmove', (e) => {
        if (!isResizing) return;

        const deltaY = startY - e.touches[0].clientY;
        const newHeight = Math.min(Math.max(startHeight + deltaY, 100), window.innerHeight * 0.7);
        tablePanel.style.height = newHeight + 'px';
        map.invalidateSize();
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          resizeHandle.classList.remove('dragging');
        }
      });
    }

    // ========================================
    // Accordion Toggle
    // ========================================
    function setupAccordions() {
      document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          const accordion = header.closest('.accordion');
          accordion.classList.toggle('open');
        });
      });
    }

    // ========================================
    // Map Context Menu (Right-Click)
    // ========================================
    let contextMenuLatLng = null;

    function setupContextMenu() {
      const contextMenu = document.getElementById('map-context-menu');
      const contextMenuCoords = document.getElementById('context-menu-coords');
      const contextMenuCoordsText = document.getElementById('context-menu-coords-text');
      const contextMenuShare = document.getElementById('context-menu-share');
      const contextMenuCenter = document.getElementById('context-menu-center');
      const contextMenuNearest = document.getElementById('context-menu-nearest');
      const mapContainer = document.getElementById('map');

      // Show context menu on right-click
      map.on('contextmenu', function(e) {
        e.originalEvent.preventDefault();

        // Store clicked coordinates
        contextMenuLatLng = e.latlng;

        // Update coordinates display
        const lat = contextMenuLatLng.lat.toFixed(5);
        const lng = contextMenuLatLng.lng.toFixed(5);
        contextMenuCoordsText.textContent = lat + ', ' + lng;
        contextMenuCoords.classList.remove('copied');

        // Get map container dimensions
        const mapRect = mapContainer.getBoundingClientRect();
        const menuWidth = 200;
        const menuHeight = 160;

        // Calculate click position relative to map
        const clickX = e.containerPoint.x;
        const clickY = e.containerPoint.y;

        // Edge detection
        const flipHorizontal = (clickX + menuWidth) > mapRect.width;
        const flipVertical = (clickY + menuHeight) > mapRect.height;

        // Position the menu relative to map container
        contextMenu.style.left = (mapRect.left + clickX) + 'px';
        contextMenu.style.top = (mapRect.top + clickY) + 'px';

        // Apply flip classes
        contextMenu.classList.toggle('flip-horizontal', flipHorizontal);
        contextMenu.classList.toggle('flip-vertical', flipVertical);

        // Show menu
        contextMenu.classList.add('show');

        // Refresh icons
        if (typeof lucide !== 'undefined') lucide.createIcons();
      });

      // Hide context menu function
      function hideContextMenu() {
        contextMenu.classList.remove('show');
      }

      // Hide on map click
      map.on('click', hideContextMenu);
      map.on('movestart', hideContextMenu);

      // Hide on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hideContextMenu();
        }
      });

      // Hide when clicking outside
      document.addEventListener('click', function(e) {
        if (!contextMenu.contains(e.target)) {
          hideContextMenu();
        }
      });

      // Copy coordinates
      contextMenuCoords.addEventListener('click', function() {
        const coordsText = contextMenuCoordsText.textContent;
        navigator.clipboard.writeText(coordsText).then(function() {
          contextMenuCoords.classList.add('copied');
          setTimeout(hideContextMenu, 500);
        }).catch(function(err) {
          console.error('Failed to copy coordinates:', err);
        });
      });

      // Share location
      contextMenuShare.addEventListener('click', function() {
        if (!contextMenuLatLng) return;

        const lat = contextMenuLatLng.lat.toFixed(5);
        const lng = contextMenuLatLng.lng.toFixed(5);
        const zoom = Math.round(map.getZoom());
        const shareUrl = window.location.origin + window.location.pathname +
          '?tab=karte&lat=' + lat + '&lng=' + lng + '&zoom=' + zoom;

        hideContextMenu();

        if (navigator.share) {
          navigator.share({
            title: 'BBL Liegenschaftsinventar - Standort',
            text: 'Standort anzeigen:',
            url: shareUrl
          }).catch(function(err) {
            if (err.name !== 'AbortError') {
              navigator.clipboard.writeText(shareUrl);
            }
          });
        } else {
          navigator.clipboard.writeText(shareUrl);
        }
      });

      // Center map here
      contextMenuCenter.addEventListener('click', function() {
        if (!contextMenuLatLng) return;
        map.setView(contextMenuLatLng, map.getZoom());
        hideContextMenu();
      });

      // Find nearest building
      contextMenuNearest.addEventListener('click', function() {
        if (!contextMenuLatLng) return;

        let nearestBuilding = null;
        let minDistance = Infinity;

        buildings.forEach(function(building) {
          const distance = map.distance(contextMenuLatLng, [building.lat, building.lng]);
          if (distance < minDistance) {
            minDistance = distance;
            nearestBuilding = building;
          }
        });

        if (nearestBuilding) {
          selectBuilding(nearestBuilding.id);
        }

        hideContextMenu();
      });
    }
  </script>
</body>
</html>
