<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BBL Liegenschaftsinventar - Korrekturen</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="css/tokens.css">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="assets/swiss-logo-flag.svg" alt="Schweizerische Eidgenossenschaft" class="logo-flag">
      <div class="logo-text">
        <div class="logo-text-primary">Bundesamt für Bauten und Logistik</div>
        <div class="logo-text-secondary">Korrekturen Liegenschaftsinventar</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="karte">Karte</button>
      <button class="nav-tab" data-tab="aufgaben">Aufgaben</button>
      <button class="nav-tab" data-tab="statistik">Statistik</button>
      <button class="nav-tab" data-tab="settings">Einstellungen & Export</button>
    </nav>

    <div class="header-actions">
      <div class="search-container" id="search-container">
        <button class="search-toggle" id="search-toggle" type="button">
          <i data-lucide="search" class="icon"></i>
        </button>
        <input type="text" class="search-input" placeholder="Suchen..." id="globalSearch">
      </div>
      <button class="filter-toggle active" id="filter-toggle" type="button">
        <i data-lucide="sliders-horizontal" class="icon"></i>
      </button>
      <div class="user-avatar">MK</div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Global Filter Bar -->
    <div class="filter-bar" id="filter-bar">
      <div class="filter-chips">
        <button class="filter-chip priority-high" data-filter="high">
          <span class="priority-indicator high"></span>
          <span>Hoch</span>
          <span class="count" id="count-high">(3)</span>
        </button>
        <button class="filter-chip priority-medium" data-filter="medium">
          <span class="priority-indicator medium"></span>
          <span>Mittel</span>
          <span class="count" id="count-medium">(4)</span>
        </button>
        <button class="filter-chip priority-low" data-filter="low">
          <span class="priority-indicator low"></span>
          <span>Niedrig</span>
          <span class="count" id="count-low">(5)</span>
        </button>
      </div>
      <div class="filter-divider"></div>
      <button class="filter-chip" data-filter="my-tasks">Meine Aufgaben</button>
      <div class="filter-divider"></div>

      <!-- Multi-select: Kanton -->
      <div class="multi-select" id="filter-kanton">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Kanton</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="TG"><span>TG</span></label>
            <label class="multi-select-option"><input type="checkbox" value="SG"><span>SG</span></label>
            <label class="multi-select-option"><input type="checkbox" value="ZH"><span>ZH</span></label>
            <label class="multi-select-option"><input type="checkbox" value="BE"><span>BE</span></label>
            <label class="multi-select-option"><input type="checkbox" value="GR"><span>GR</span></label>
            <label class="multi-select-option"><input type="checkbox" value="LU"><span>LU</span></label>
            <label class="multi-select-option"><input type="checkbox" value="GE"><span>GE</span></label>
            <label class="multi-select-option"><input type="checkbox" value="TI"><span>TI</span></label>
            <label class="multi-select-option"><input type="checkbox" value="BS"><span>BS</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Konfidenz -->
      <div class="multi-select" id="filter-confidence">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Konfidenz</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="critical"><span>Kritisch</span></label>
            <label class="multi-select-option"><input type="checkbox" value="warning"><span>Warnung</span></label>
            <label class="multi-select-option"><input type="checkbox" value="ok"><span>OK</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Portfolio -->
      <div class="multi-select" id="filter-portfolio">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Portfolio</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="Büro"><span>Büro</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Wohnen"><span>Wohnen</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Öffentlich"><span>Öffentlich</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Industrie"><span>Industrie</span></label>
            <label class="multi-select-option"><input type="checkbox" value="Bildung"><span>Bildung</span></label>
          </div>
        </div>
      </div>

      <!-- Multi-select: Zugewiesen -->
      <div class="multi-select" id="filter-assignee">
        <button class="multi-select-trigger" type="button">
          <span class="multi-select-label">Zugewiesen</span>
          <i data-lucide="chevron-down" class="icon-sm"></i>
        </button>
        <div class="multi-select-dropdown">
          <div class="multi-select-actions">
            <button type="button" class="multi-select-action" data-action="all">Alle</button>
            <button type="button" class="multi-select-action" data-action="none">Keine</button>
          </div>
          <div class="multi-select-options">
            <label class="multi-select-option"><input type="checkbox" value="M. Keller"><span>M. Keller</span></label>
            <label class="multi-select-option"><input type="checkbox" value="S. Brunner"><span>S. Brunner</span></label>
            <label class="multi-select-option"><input type="checkbox" value="T. Weber"><span>T. Weber</span></label>
            <label class="multi-select-option"><input type="checkbox" value="A. Meier"><span>A. Meier</span></label>
            <label class="multi-select-option"><input type="checkbox" value=""><span>Nicht zugewiesen</span></label>
          </div>
        </div>
      </div>

      <div class="filter-divider"></div>
      <button class="filter-reset-btn" id="filter-reset" type="button">
        <i data-lucide="rotate-ccw" class="icon-sm"></i>
        <span>Zurücksetzen</span>
      </button>

      <div class="filter-spacer"></div>
      <div class="filter-total" id="filter-total">
        <span id="filtered-count">12</span> / <span id="total-count">20</span> Gebäude
      </div>
    </div>

    <!-- Karte Tab -->
    <div class="tab-content active" id="tab-karte">
      <div class="karte-layout">
        <!-- Map Container (map + table) -->
        <div class="map-container">
          <!-- Map Panel -->
          <div class="map-panel">
            <div id="map"></div>

            <!-- Layer Visibility Widget -->
            <div class="layer-widget" id="layer-widget">
              <button class="layer-widget-trigger" id="layer-widget-trigger" title="Kartenebenen">
                <i data-lucide="layers" class="icon"></i>
              </button>
              <div class="layer-widget-panel" id="layer-widget-panel">
                <div class="layer-widget-header" title="Einklappen">
                  <i data-lucide="layers" class="icon"></i>
                  <span>Kartenebenen</span>
                  <i data-lucide="chevron-up" class="icon-sm"></i>
                </div>
                <div class="layer-widget-content">
                  <label class="layer-item">
                    <input type="checkbox" id="layer-oereb" data-layer="ch.swisstopo-vd.stand-oerebkataster">
                    <span class="layer-name">ÖREB Verfügbarkeit</span>
                    <button class="layer-info-btn" data-layer="ch.swisstopo-vd.stand-oerebkataster" title="Layer-Info">
                      <i data-lucide="info" class="icon-sm"></i>
                    </button>
                  </label>
                  <label class="layer-item">
                    <input type="checkbox" id="layer-gwr" data-layer="ch.bfs.gebaeude_wohnungs_register">
                    <span class="layer-name">GWR Gebäudestatus</span>
                    <button class="layer-info-btn" data-layer="ch.bfs.gebaeude_wohnungs_register" title="Layer-Info">
                      <i data-lucide="info" class="icon-sm"></i>
                    </button>
                  </label>
                </div>
                <div class="layer-widget-footer">
                  <span>© Swisstopo</span>
                </div>
              </div>
            </div>

            <div class="basemap-selector" id="basemap-selector">
              <div class="basemap-panel" id="basemap-panel">
                <button class="basemap-option" data-basemap="none">
                  <div class="basemap-thumb basemap-none"><span>Kein HG</span></div>
                </button>
                <button class="basemap-option" data-basemap="grey">
                  <div class="basemap-thumb basemap-grey"><span>Grau</span></div>
                </button>
                <button class="basemap-option active" data-basemap="color">
                  <div class="basemap-thumb basemap-color"><span>Farbig</span></div>
                </button>
                <button class="basemap-option" data-basemap="satellite">
                  <div class="basemap-thumb basemap-satellite"><span>Luftbild</span></div>
                </button>
              </div>
              <button class="basemap-trigger" id="basemap-trigger" title="Hintergrund wechseln">
                <div class="basemap-thumb basemap-color" id="basemap-trigger-thumb">
                  <span id="basemap-trigger-label">Farbig</span>
                  <i data-lucide="chevron-right" class="icon-sm trigger-chevron"></i>
                </div>
              </button>
            </div>

            <!-- Scale Bar -->
            <div class="scale-bar" id="scale-bar">
              <div class="scale-bar-line" id="scale-bar-line"></div>
              <span class="scale-bar-text" id="scale-bar-text">100 m</span>
            </div>

            <button class="table-toggle-btn active" id="table-toggle-btn">
              <i data-lucide="chevron-up" class="icon-sm chevron"></i>
              <span>Tabelle</span>
            </button>
          </div>

          <!-- Table View Panel (hidden by default) -->
          <div class="table-panel visible" id="table-panel">
            <div class="table-resize-handle" id="table-resize-handle">
              <div class="resize-handle-bar"></div>
            </div>
            <div class="table-panel-header">
              <div class="table-panel-title">
                <i data-lucide="table-2" class="icon"></i>
                <span>Tabellenansicht</span>
                <span id="table-count">(0)</span>
              </div>
              <button class="table-panel-close" id="table-close-btn">
                <i data-lucide="x" class="icon"></i>
              </button>
            </div>
            <div class="table-panel-content">
              <table class="buildings-table">
                <thead>
                  <tr>
                    <th>Priorität</th>
                    <th>SAP ID</th>
                    <th>Name</th>
                    <th>Kanton</th>
                    <th>Konfidenz</th>
                    <th>Fehlertypen</th>
                    <th>Zugewiesen</th>
                    <th>Aktualisiert</th>
                  </tr>
                </thead>
                <tbody id="table-body">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Detail Panel -->
        <div class="detail-panel" id="detail-panel">
          <div class="detail-resize-handle" id="detail-resize-handle">
            <div class="resize-handle-bar-vertical"></div>
          </div>
          <div class="detail-content" id="detail-content">
            <div class="detail-header">
              <button class="detail-close-btn" id="detail-close-btn" title="Schliessen">
                <i data-lucide="x"></i>
              </button>
              <h2 class="detail-title" id="detail-title">Building Name</h2>
              <p class="detail-subtitle" id="detail-sap-id">SAP ID</p>
            </div>

            <div class="detail-section accordion open" data-accordion="konfidenz">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Konfidenz</span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div class="confidence-container">
                  <div class="confidence-total" id="confidence-total">67%</div>
                  <div class="confidence-bars">
                    <div class="confidence-bar-row">
                      <span class="confidence-bar-label">Georef</span>
                      <div class="confidence-bar-track">
                        <div class="confidence-bar-fill" id="bar-georef" style="width: 67%"></div>
                      </div>
                      <span class="confidence-bar-value" id="val-georef">67%</span>
                    </div>
                    <div class="confidence-bar-row">
                      <span class="confidence-bar-label">SAP</span>
                      <div class="confidence-bar-track">
                        <div class="confidence-bar-fill ok" id="bar-sap" style="width: 100%"></div>
                      </div>
                      <span class="confidence-bar-value" id="val-sap">100%</span>
                    </div>
                    <div class="confidence-bar-row">
                      <span class="confidence-bar-label">GWR</span>
                      <div class="confidence-bar-track">
                        <div class="confidence-bar-fill ok" id="bar-gwr" style="width: 100%"></div>
                      </div>
                      <span class="confidence-bar-value" id="val-gwr">100%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section accordion" data-accordion="fehler">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Fehler</span>
                <span class="accordion-count" id="error-count"></span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div id="error-cards">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>

            <div class="detail-section accordion open" data-accordion="status">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Status & Zugewiesen</span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div class="status-section">
                  <div class="status-row">
                    <span class="status-label">Status</span>
                    <span class="status-badge" id="detail-status">Backlog</span>
                  </div>
                  <div class="status-row">
                    <span class="status-label">Zugewiesen</span>
                    <div class="assignee-display" id="assignee-display">
                      <!-- Populated by JS -->
                    </div>
                  </div>
                  <button class="status-action-link" id="btn-done" type="button">
                    <i data-lucide="check-circle" class="icon-sm"></i>
                    Als erledigt markieren
                  </button>
                </div>
              </div>
            </div>

            <div class="detail-section accordion open" data-accordion="datenvergleich">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Datenvergleich</span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>Attribut</th>
                      <th>SAP RE-FX</th>
                      <th>GWR</th>
                    </tr>
                  </thead>
                  <tbody id="data-comparison">
                    <!-- Populated by JS -->
                  </tbody>
                </table>
                <div class="data-actions">
                  <button class="data-correct-btn" id="btn-correct" type="button">
                    <i data-lucide="edit-3" class="icon-sm"></i>
                    Korrigieren
                  </button>
                  <div class="edit-actions" id="edit-actions" style="display: none;">
                    <button class="edit-cancel-btn" id="btn-edit-cancel" type="button">Abbrechen</button>
                    <button class="edit-save-btn" id="btn-edit-save" type="button">
                      <i data-lucide="check" class="icon-sm"></i>
                      Speichern
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section accordion" data-accordion="kommentare">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Kommentare</span>
                <span class="accordion-count" id="comments-count"></span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div id="comments-list">
                  <!-- Populated by JS -->
                </div>
                <div class="comment-input-section">
                  <textarea class="comment-input" id="comment-input" placeholder="Kommentar schreiben..." rows="2"></textarea>
                  <div class="comment-actions">
                    <button class="action-btn secondary btn-sm" id="btn-cancel-comment" type="button">Abbrechen</button>
                    <button class="action-btn primary btn-sm" id="btn-submit-comment" type="button">Senden</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section accordion" data-accordion="ereignisse">
              <button class="accordion-header" type="button">
                <span class="accordion-title">Ereignisse</span>
                <span class="accordion-count" id="events-count"></span>
                <i data-lucide="chevron-down" class="icon-sm accordion-chevron"></i>
              </button>
              <div class="accordion-content">
                <div class="events-list" id="events-list">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aufgaben Tab -->
    <div class="tab-content" id="tab-aufgaben">
      <div class="aufgaben-content">
        <div class="kanban-container">
          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="layers" class="icon"></i></span>
              <span class="kanban-header-title">Backlog</span>
              <span class="kanban-header-count" id="kanban-backlog-count">234</span>
            </div>
            <div class="kanban-cards" id="kanban-backlog">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="play-circle" class="icon"></i></span>
              <span class="kanban-header-title">In Arbeit</span>
              <span class="kanban-header-count" id="kanban-inprogress-count">89</span>
            </div>
            <div class="kanban-cards" id="kanban-inprogress">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="help-circle" class="icon"></i></span>
              <span class="kanban-header-title">Benötigt Abklärung</span>
              <span class="kanban-header-count" id="kanban-clarification-count">34</span>
            </div>
            <div class="kanban-cards" id="kanban-clarification">
              <!-- Populated by JS -->
            </div>
          </div>

          <div class="kanban-column">
            <div class="kanban-header">
              <span class="kanban-header-icon"><i data-lucide="check-circle" class="icon"></i></span>
              <span class="kanban-header-title">Erledigt</span>
              <span class="kanban-header-count" id="kanban-done-count">1'842</span>
            </div>
            <div class="kanban-cards" id="kanban-done">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Statistik Tab -->
    <div class="tab-content" id="tab-statistik">
      <div class="statistik-content">
        <div class="stat-cards stat-cards-6">
          <div class="stat-card">
            <div class="stat-label">Gebäude</div>
            <div class="stat-value" id="stat-total">20</div>
            <div class="stat-sublabel">Total im Filter</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Datenqualität</div>
            <div class="stat-value" id="stat-quality">68%</div>
            <div class="stat-sublabel">Ø Konfidenz</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Fehler</div>
            <div class="stat-value error" id="stat-errors">24</div>
            <div class="stat-sublabel">Alle Abweichungen</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Kritisch</div>
            <div class="stat-value error" id="stat-critical">12</div>
            <div class="stat-sublabel">Konfidenz &lt; 50%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Validiert</div>
            <div class="stat-value success" id="stat-validated">3</div>
            <div class="stat-sublabel">Konfidenz ≥ 90%</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Offen</div>
            <div class="stat-value" id="stat-pending">17</div>
            <div class="stat-sublabel">Nicht erledigt</div>
          </div>
        </div>

        <div class="charts-grid">
          <!-- Confidence Distribution -->
          <div class="chart-card">
            <h3 class="chart-title">Konfidenz-Verteilung</h3>
            <div class="histogram-chart" id="confidence-histogram">
              <div class="histogram-bar-group">
                <div class="histogram-bar critical" style="height: 60%"></div>
                <span class="histogram-label">0-40%</span>
                <span class="histogram-value">4</span>
              </div>
              <div class="histogram-bar-group">
                <div class="histogram-bar warning" style="height: 45%"></div>
                <span class="histogram-label">40-60%</span>
                <span class="histogram-value">3</span>
              </div>
              <div class="histogram-bar-group">
                <div class="histogram-bar moderate" style="height: 80%"></div>
                <span class="histogram-label">60-80%</span>
                <span class="histogram-value">10</span>
              </div>
              <div class="histogram-bar-group">
                <div class="histogram-bar success" style="height: 25%"></div>
                <span class="histogram-label">80-100%</span>
                <span class="histogram-value">3</span>
              </div>
            </div>
          </div>

          <!-- Errors by Severity -->
          <div class="chart-card">
            <h3 class="chart-title">Fehler nach Schweregrad</h3>
            <div class="severity-chart" id="severity-chart">
              <div class="severity-bars">
                <div class="severity-bar-row">
                  <span class="severity-indicator error"></span>
                  <span class="severity-label">Fehler</span>
                  <div class="severity-bar-track">
                    <div class="severity-bar-fill error" style="width: 60%"></div>
                  </div>
                  <span class="severity-value">12</span>
                </div>
                <div class="severity-bar-row">
                  <span class="severity-indicator warning"></span>
                  <span class="severity-label">Warnung</span>
                  <div class="severity-bar-track">
                    <div class="severity-bar-fill warning" style="width: 40%"></div>
                  </div>
                  <span class="severity-value">8</span>
                </div>
                <div class="severity-bar-row">
                  <span class="severity-indicator info"></span>
                  <span class="severity-label">Hinweis</span>
                  <div class="severity-bar-track">
                    <div class="severity-bar-fill info" style="width: 20%"></div>
                  </div>
                  <span class="severity-value">4</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Errors by Source -->
          <div class="chart-card">
            <h3 class="chart-title">Abweichungen nach Quelle</h3>
            <div class="source-chart" id="source-chart">
              <div class="chart-row">
                <span class="chart-row-label">Georef</span>
                <div class="chart-row-bar">
                  <div class="chart-row-fill georef" style="width: 70%"></div>
                </div>
                <span class="chart-row-value">14</span>
              </div>
              <div class="chart-row">
                <span class="chart-row-label">GWR</span>
                <div class="chart-row-bar">
                  <div class="chart-row-fill gwr" style="width: 40%"></div>
                </div>
                <span class="chart-row-value">8</span>
              </div>
              <div class="chart-row">
                <span class="chart-row-label">SAP</span>
                <div class="chart-row-bar">
                  <div class="chart-row-fill sap" style="width: 55%"></div>
                </div>
                <span class="chart-row-value">11</span>
              </div>
              <div class="chart-row">
                <span class="chart-row-label">Adresse</span>
                <div class="chart-row-bar">
                  <div class="chart-row-fill address" style="width: 25%"></div>
                </div>
                <span class="chart-row-value">5</span>
              </div>
            </div>
          </div>

          <!-- Status by Canton -->
          <div class="chart-card">
            <h3 class="chart-title">Status nach Kanton</h3>
            <div class="kanton-chart" id="kanton-chart">
              <div class="kanton-row">
                <span class="kanton-label">ZH</span>
                <div class="kanton-bar-track">
                  <div class="kanton-bar-fill" style="width: 85%"></div>
                </div>
                <span class="kanton-value">85%</span>
              </div>
              <div class="kanton-row">
                <span class="kanton-label">BE</span>
                <div class="kanton-bar-track">
                  <div class="kanton-bar-fill" style="width: 72%"></div>
                </div>
                <span class="kanton-value">72%</span>
              </div>
              <div class="kanton-row">
                <span class="kanton-label">SG</span>
                <div class="kanton-bar-track">
                  <div class="kanton-bar-fill" style="width: 68%"></div>
                </div>
                <span class="kanton-value">68%</span>
              </div>
              <div class="kanton-row">
                <span class="kanton-label">LU</span>
                <div class="kanton-bar-track">
                  <div class="kanton-bar-fill" style="width: 55%"></div>
                </div>
                <span class="kanton-value">55%</span>
              </div>
              <div class="kanton-row">
                <span class="kanton-label">GR</span>
                <div class="kanton-bar-track">
                  <div class="kanton-bar-fill" style="width: 42%"></div>
                </div>
                <span class="kanton-value">42%</span>
              </div>
            </div>
          </div>

          <!-- Tasks per Assignee -->
          <div class="chart-card">
            <h3 class="chart-title">Aufgaben pro Bearbeiter</h3>
            <div class="assignee-chart" id="assignee-chart">
              <!-- Will be populated dynamically -->
            </div>
          </div>

          <!-- Status by Portfolio -->
          <div class="chart-card">
            <h3 class="chart-title">Status nach Portfolio</h3>
            <div class="portfolio-chart" id="portfolio-chart">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Einstellungen & Export Tab -->
    <div class="tab-content" id="tab-settings">
      <div class="settings-content">
        <!-- User Management Section -->
        <div class="settings-section">
          <div class="section-header-with-action">
            <h2 class="settings-section-title section-title-icon"><i data-lucide="users" class="icon-lg"></i> Benutzerverwaltung</h2>
            <button class="action-btn primary btn-sm" onclick="openModal('modal-invite-user')">
              <i data-lucide="user-plus" class="icon-sm"></i>
              Einladen
            </button>
          </div>
          <table class="users-table">
            <thead>
              <tr>
                <th>Benutzer</th>
                <th>Rolle</th>
                <th>Status</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody id="users-table-body">
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="user-avatar">MK</div>
                    <div class="user-details">
                      <span class="user-name">M. Keller</span>
                      <span class="user-email">m.keller@bbl.admin.ch</span>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-ok">Admin</span></td>
                <td><span class="status-indicator active">Aktiv</span></td>
                <td><button class="icon-btn" title="Bearbeiten"><i data-lucide="pencil" class="icon-sm"></i></button></td>
              </tr>
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="user-avatar">SB</div>
                    <div class="user-details">
                      <span class="user-name">S. Brunner</span>
                      <span class="user-email">s.brunner@bbl.admin.ch</span>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-warning">Bearbeiter</span></td>
                <td><span class="status-indicator active">Aktiv</span></td>
                <td>
                  <button class="icon-btn" title="Bearbeiten"><i data-lucide="pencil" class="icon-sm"></i></button>
                  <button class="icon-btn danger" title="Entfernen"><i data-lucide="trash-2" class="icon-sm"></i></button>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="user-avatar">TW</div>
                    <div class="user-details">
                      <span class="user-name">T. Weber</span>
                      <span class="user-email">t.weber@bbl.admin.ch</span>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-warning">Bearbeiter</span></td>
                <td><span class="status-indicator active">Aktiv</span></td>
                <td>
                  <button class="icon-btn" title="Bearbeiten"><i data-lucide="pencil" class="icon-sm"></i></button>
                  <button class="icon-btn danger" title="Entfernen"><i data-lucide="trash-2" class="icon-sm"></i></button>
                </td>
              </tr>
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="user-avatar">AM</div>
                    <div class="user-details">
                      <span class="user-name">A. Meier</span>
                      <span class="user-email">a.meier@bbl.admin.ch</span>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-georef">Leser</span></td>
                <td><span class="status-indicator pending">Eingeladen</span></td>
                <td>
                  <button class="icon-btn" title="Erneut einladen"><i data-lucide="mail" class="icon-sm"></i></button>
                  <button class="icon-btn danger" title="Entfernen"><i data-lucide="trash-2" class="icon-sm"></i></button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Export Section -->
        <div class="settings-section">
          <h2 class="settings-section-title section-title-icon"><i data-lucide="download" class="icon-lg"></i> Export</h2>
          <div class="export-buttons">
            <button class="export-btn"><i data-lucide="download" class="icon-sm"></i> Checkliste Vor-Ort <span class="export-type">PDF</span></button>
            <button class="export-btn"><i data-lucide="download" class="icon-sm"></i> Excel Massenkorrektur <span class="export-type">XLSX</span></button>
            <button class="export-btn"><i data-lucide="download" class="icon-sm"></i> Fehlerbericht <span class="export-type">CSV</span></button>
            <button class="export-btn"><i data-lucide="download" class="icon-sm"></i> Meine Aufgaben <span class="export-type">PDF</span></button>
          </div>
        </div>

        <!-- Checking Rules Section -->
        <div class="settings-section">
          <div class="section-header-with-action">
            <h2 class="settings-section-title section-title-icon"><i data-lucide="shield-check" class="icon-lg"></i> Prüfregeln</h2>
            <button class="action-btn primary btn-sm" id="run-all-checks">
              <i data-lucide="play" class="icon-sm"></i>
              Prüfung starten
            </button>
          </div>
          <p class="section-description">Diese Regeln werden automatisch auf alle Gebäude angewendet.</p>
          <div class="rules-container" id="rules-container">
            <div class="rules-loading">Regeln werden geladen...</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="footer-links">
      <a href="mailto:dres@bbl.admin.ch">Kontakt</a>
      <a href="https://www.admin.ch/gov/de/start/rechtliches.html" target="_blank" rel="noopener">Rechtliches</a>
      <a href="https://github.com/davras5/geo-check" target="_blank" rel="noopener">Quellcode</a>
      <a href="#" class="footer-link-placeholder">API</a>
    </div>
    <div class="footer-version">v0.1.0</div>
  </footer>

  <!-- Invite User Modal -->
  <div class="modal-overlay" id="modal-invite-user">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Benutzer einladen</h3>
        <button class="modal-close" onclick="closeModal('modal-invite-user')">×</button>
      </div>
      <div class="modal-body">
        <label class="modal-label">E-Mail-Adresse</label>
        <input type="email" class="modal-input" placeholder="name@bbl.admin.ch">

        <label class="modal-label">Rolle</label>
        <select class="modal-select">
          <option value="reader">Leser - Nur Ansicht</option>
          <option value="editor" selected>Bearbeiter - Kann Daten bearbeiten</option>
          <option value="admin">Admin - Voller Zugriff</option>
        </select>

        <label class="modal-label">Nachricht (optional)</label>
        <textarea class="modal-textarea" placeholder="Persönliche Nachricht zur Einladung..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="modal-btn cancel" onclick="closeModal('modal-invite-user')">Abbrechen</button>
        <button class="modal-btn primary">Einladung senden</button>
      </div>
    </div>
  </div>

  <!-- Map Context Menu (Right-Click) -->
  <div id="map-context-menu" class="map-context-menu">
    <div class="context-menu-item context-menu-coords" id="context-menu-coords" title="Klicken zum Kopieren">
      <i data-lucide="copy" class="icon-sm"></i>
      <span id="context-menu-coords-text">47.37623, 8.53048</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="context-menu-share">
      <i data-lucide="share-2" class="icon-sm"></i>
      <span>Teilen</span>
    </div>
    <div class="context-menu-item" id="context-menu-center">
      <i data-lucide="crosshair" class="icon-sm"></i>
      <span>Hier zentrieren</span>
    </div>
    <div class="context-menu-item" id="context-menu-nearest">
      <i data-lucide="map-pin" class="icon-sm"></i>
      <span>Nächstes Objekt</span>
    </div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" id="context-menu-google-maps">
      <i data-lucide="map" class="icon-sm"></i>
      <span>In Google Maps öffnen</span>
    </div>
    <div class="context-menu-item" id="context-menu-swisstopo">
      <i data-lucide="mountain" class="icon-sm"></i>
      <span>In Swisstopo öffnen</span>
    </div>
    <div class="context-menu-item" id="context-menu-google-earth">
      <i data-lucide="globe" class="icon-sm"></i>
      <span>In Google Earth 3D öffnen</span>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ========================================
    // Data (loaded from JSON files)
    // ========================================
    let teamMembers = [];
    let buildings = [];
    let events = [];
    let errors = {};
    let comments = {};
    let rulesConfig = null;

    async function loadData() {
      try {
        const [buildingsResponse, usersResponse, eventsResponse, errorsResponse, commentsResponse, rulesResponse] = await Promise.all([
          fetch('data/buildings.json'),
          fetch('data/users.json'),
          fetch('data/events.json'),
          fetch('data/errors.json'),
          fetch('data/comments.json'),
          fetch('data/rules.json')
        ]);

        if (!buildingsResponse.ok || !usersResponse.ok || !eventsResponse.ok || !errorsResponse.ok || !commentsResponse.ok) {
          throw new Error('Failed to load data files');
        }

        buildings = await buildingsResponse.json();
        teamMembers = await usersResponse.json();
        events = await eventsResponse.json();
        errors = await errorsResponse.json();
        comments = await commentsResponse.json();

        if (rulesResponse.ok) {
          rulesConfig = await rulesResponse.json();
        }

        // Merge errors and comments into buildings
        buildings.forEach(building => {
          building.errors = errors[building.id] || [];
          building.comments = comments[building.id] || [];
        });

        console.log(`Loaded ${buildings.length} buildings, ${teamMembers.length} team members, ${events.length} events, ${Object.keys(errors).length} error sets, ${Object.keys(comments).length} comment sets`);
      } catch (error) {
        console.error('Error loading data:', error);
        // Show error to user
        document.body.innerHTML = `
          <div class="error-container">
            <h1>Fehler beim Laden der Daten</h1>
            <p>Die Anwendung konnte die Daten nicht laden. Bitte stellen Sie sicher, dass die Anwendung über einen Webserver ausgeführt wird.</p>
            <code>${error.message}</code>
          </div>
        `;
        throw error;
      }
    }

    // ========================================
    // State
    // ========================================
    let state = {
      selectedBuildingId: null,
      activeFilters: {
        high: false,
        medium: false,
        low: false,
        myTasks: false
      },
      filterKanton: [],      // Empty array = show all
      filterConfidence: [],  // Empty array = show all
      filterPortfolio: [],   // Empty array = show all
      filterAssignee: [],    // Empty array = show all
      currentTab: 'karte',
      // Edit mode state
      editMode: false,
      originalBuildingData: null,  // Backup for cancel
      editedCoords: null           // Track dragged marker position
    };

    let map;
    let markers = {};

    // ========================================
    // Coordinate Conversion (WGS84 to LV95)
    // ========================================
    function wgs84ToLV95(lat, lng) {
      // Convert decimal degrees to sexagesimal seconds
      const latSec = lat * 3600;
      const lngSec = lng * 3600;

      // Auxiliary values (Bern as origin)
      const latAux = (latSec - 169028.66) / 10000;
      const lngAux = (lngSec - 26782.5) / 10000;

      // Easting (E)
      const E = 2600072.37
        + 211455.93 * lngAux
        - 10938.51 * lngAux * latAux
        - 0.36 * lngAux * latAux * latAux
        - 44.54 * lngAux * lngAux * lngAux;

      // Northing (N)
      const N = 1200147.07
        + 308807.95 * latAux
        + 3745.25 * lngAux * lngAux
        + 76.63 * latAux * latAux
        - 194.56 * lngAux * lngAux * latAux
        + 119.79 * latAux * latAux * latAux;

      return { E: Math.round(E), N: Math.round(N) };
    }

    // ========================================
    // URL Navigation
    // ========================================
    function updateURL(replace = false) {
      const params = new URLSearchParams();

      // Add current tab
      params.set('tab', state.currentTab);

      // Add selected building if any
      if (state.selectedBuildingId) {
        params.set('id', state.selectedBuildingId);
      }

      // Add active filters (only non-default values)
      const defaultFilters = { high: false, medium: false, low: false, myTasks: false };
      const filterDiff = [];
      Object.entries(state.activeFilters).forEach(([key, value]) => {
        if (value !== defaultFilters[key]) {
          filterDiff.push(value ? key : `-${key}`);
        }
      });
      if (filterDiff.length > 0) {
        params.set('filters', filterDiff.join(','));
      }

      // Add dropdown filters
      if (state.filterKanton.length > 0) params.set('kanton', state.filterKanton.join(','));
      if (state.filterConfidence.length > 0) params.set('confidence', state.filterConfidence.join(','));
      if (state.filterPortfolio.length > 0) params.set('portfolio', state.filterPortfolio.join(','));
      if (state.filterAssignee.length > 0) params.set('assignee', state.filterAssignee.join(','));

      // Add table visibility (only add param if hidden, since visible is default)
      if (!tableVisible) params.set('table', '0');

      // Update URL without page reload
      const newURL = `${window.location.pathname}?${params.toString()}`;
      if (replace) {
        window.history.replaceState({ ...state, tableVisible }, '', newURL);
      } else {
        window.history.pushState({ ...state, tableVisible }, '', newURL);
      }
    }

    function parseURL() {
      const params = new URLSearchParams(window.location.search);

      // Parse tab
      const tab = params.get('tab');
      if (tab && ['karte', 'aufgaben', 'statistik', 'settings'].includes(tab)) {
        state.currentTab = tab;
      }

      // Parse selected building
      const buildingId = params.get('id');
      if (buildingId) {
        state.selectedBuildingId = buildingId;
      }

      // Parse filters
      const filters = params.get('filters');
      if (filters) {
        filters.split(',').forEach(filter => {
          if (filter.startsWith('-')) {
            const key = filter.substring(1);
            if (state.activeFilters.hasOwnProperty(key)) {
              state.activeFilters[key] = false;
            }
          } else if (filter === 'myTasks') {
            state.activeFilters.myTasks = true;
          } else if (state.activeFilters.hasOwnProperty(filter)) {
            state.activeFilters[filter] = true;
          }
        });
      }

      // Parse dropdown filters (comma-separated values, empty = show all)
      const kantonParam = params.get('kanton');
      const confidenceParam = params.get('confidence');
      const portfolioParam = params.get('portfolio');
      const assigneeParam = params.get('assignee');
      state.filterKanton = kantonParam ? kantonParam.split(',') : [];
      state.filterConfidence = confidenceParam ? confidenceParam.split(',') : [];
      state.filterPortfolio = portfolioParam ? portfolioParam.split(',') : [];
      state.filterAssignee = assigneeParam ? assigneeParam.split(',') : [];

      // Return table visibility (default is visible, so check for explicit hide)
      return params.get('table') !== '0';
    }

    function applyURLState() {
      const shouldShowTable = parseURL();

      // Apply tab UI
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === state.currentTab);
      });
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${state.currentTab}`);
      });

      // Apply filters UI
      document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
        const filterName = chip.dataset.filter;
        if (filterName === 'my-tasks') {
          chip.classList.toggle('active', state.activeFilters.myTasks);
        } else if (state.activeFilters.hasOwnProperty(filterName)) {
          chip.classList.toggle('active', state.activeFilters[filterName]);
        }
      });

      // Apply multi-select filter checkboxes
      applyMultiSelectState('filter-kanton', state.filterKanton);
      applyMultiSelectState('filter-confidence', state.filterConfidence);
      applyMultiSelectState('filter-portfolio', state.filterPortfolio);
      applyMultiSelectState('filter-assignee', state.filterAssignee);

      // Apply table visibility (default is visible)
      tableVisible = shouldShowTable;
      document.getElementById('table-panel').classList.toggle('visible', tableVisible);
      document.getElementById('table-toggle-btn').classList.toggle('active', tableVisible);

      // Set initial URL state (replace to not add to history)
      updateURL(true);
    }

    function handlePopState(event) {
      if (event.state) {
        // Restore state from history
        state.currentTab = event.state.currentTab || 'karte';
        state.selectedBuildingId = event.state.selectedBuildingId || null;
        state.activeFilters = event.state.activeFilters || { high: false, medium: false, low: false, myTasks: false };
        state.filterKanton = event.state.filterKanton || [];
        state.filterConfidence = event.state.filterConfidence || [];
        state.filterPortfolio = event.state.filterPortfolio || [];
        state.filterAssignee = event.state.filterAssignee || [];
        tableVisible = event.state.tableVisible !== undefined ? event.state.tableVisible : true;

        // Apply tab
        document.querySelectorAll('.nav-tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === state.currentTab);
        });
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('active', content.id === `tab-${state.currentTab}`);
        });

        // Update filter chips UI
        document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
          const filterName = chip.dataset.filter;
          if (filterName === 'my-tasks') {
            chip.classList.toggle('active', state.activeFilters.myTasks);
          } else if (state.activeFilters.hasOwnProperty(filterName)) {
            chip.classList.toggle('active', state.activeFilters[filterName]);
          }
        });

        // Update multi-select dropdowns
        applyMultiSelectState('filter-kanton', state.filterKanton);
        applyMultiSelectState('filter-confidence', state.filterConfidence);
        applyMultiSelectState('filter-portfolio', state.filterPortfolio);
        applyMultiSelectState('filter-assignee', state.filterAssignee);

        // Update table visibility
        document.getElementById('table-panel').classList.toggle('visible', tableVisible);
        document.getElementById('table-toggle-btn').classList.toggle('active', tableVisible);

        // Render views
        updateMapMarkers();
        updateCounts();

        if (state.selectedBuildingId) {
          const building = buildings.find(b => b.id === state.selectedBuildingId);
          if (building) {
            // Update list selection
            document.querySelectorAll('.list-item').forEach(item => {
              item.classList.toggle('selected', item.dataset.id === state.selectedBuildingId);
            });
            // Update map
            Object.entries(markers).forEach(([markerId, marker]) => {
              const isSelected = markerId === state.selectedBuildingId;
              const markerBuilding = buildings.find(b => b.id === markerId);
              marker.setIcon(L.divIcon({
                className: 'custom-marker-container',
                html: `<div class="custom-marker ${markerBuilding.priority} ${isSelected ? 'selected' : ''}" data-id="${markerId}"></div>
                       <span class="marker-label">${markerId}</span>`,
                iconSize: isSelected ? [24, 24] : [16, 16],
                iconAnchor: isSelected ? [12, 12] : [8, 8]
              }));
            });
            map.setView([building.lat, building.lng], 18);
            renderDetailPanel(building);
          }
        } else {
          renderDetailPanel(null);
        }

        if (tableVisible) renderTableView();

        // Resize map if on karte tab
        if (state.currentTab === 'karte') {
          setTimeout(() => map.invalidateSize(), 100);
        }
      }
    }

    // ========================================
    // Initialization
    // ========================================
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Load data from JSON files
      await loadData();

      initMap();

      // Parse URL and apply initial state
      applyURLState();

      renderKanbanBoard();
      setupKanbanDragDrop();
      renderRules();
      setupEventListeners();
      setupTableViewListeners();
      setupExpandingSearch();
      setupFilterToggle();
      setupTableResize();
      setupDetailPanelResize();
      setupBasemapSelector();
      setupLayerWidget();
      setupLayerIdentify();
      setupContextMenu();
      setupAccordions();
      setupRunChecksButton();
      updateCounts();
      updateStatistik();

      // Apply building selection from URL after rendering
      if (state.selectedBuildingId) {
        selectBuilding(state.selectedBuildingId, false);
      }

      // Render table if visible
      if (tableVisible) renderTableView();

      // Listen for browser back/forward
      window.addEventListener('popstate', handlePopState);
    });

    function initMap() {
      map = L.map('map', { zoomControl: false }).setView([47.0, 8.3], 8);

      // Add zoom control to top-right
      const zoomControl = L.control.zoom({ position: 'topright' }).addTo(map);

      // Add home button to the zoom control's container
      const homeBtn = L.DomUtil.create('a', 'leaflet-control-home', zoomControl.getContainer());
      homeBtn.href = '#';
      homeBtn.title = 'Auf aktive Gebäude zoomen';
      homeBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>';
      L.DomEvent.on(homeBtn, 'click', function(e) {
        L.DomEvent.stop(e);
        zoomToVisibleMarkers();
      });

      // Initialize with default basemap (color)
      switchBasemapTiles(currentBasemap);

      buildings.forEach(building => {
        const marker = createMarker(building);
        markers[building.id] = marker;
        marker.addTo(map);
        // Disable dragging by default (needs to be done after adding to map)
        if (marker.dragging) marker.dragging.disable();
      });

      // Show/hide marker labels based on zoom level
      const mapContainer = document.getElementById('map');
      function updateLabelVisibility() {
        const zoom = map.getZoom();
        mapContainer.classList.toggle('show-labels', zoom >= 15);
      }
      map.on('zoomend', updateLabelVisibility);
      updateLabelVisibility();

      // Scale bar
      const scaleBarLine = document.getElementById('scale-bar-line');
      const scaleBarText = document.getElementById('scale-bar-text');
      function updateScaleBar() {
        const center = map.getCenter();
        const zoom = map.getZoom();
        // Meters per pixel at this latitude and zoom
        const metersPerPixel = 156543.03392 * Math.cos(center.lat * Math.PI / 180) / Math.pow(2, zoom);
        // Find a nice round distance that fits ~80-150px
        const distances = [1, 2, 5, 10, 20, 50, 100, 200, 500, 1000, 2000, 5000, 10000, 20000, 50000, 100000];
        let distance = distances[0];
        for (const d of distances) {
          const px = d / metersPerPixel;
          if (px >= 60 && px <= 150) { distance = d; break; }
          if (px < 60) distance = d;
        }
        const widthPx = Math.round(distance / metersPerPixel);
        scaleBarLine.style.width = widthPx + 'px';
        scaleBarText.textContent = distance >= 1000 ? (distance / 1000) + ' km' : distance + ' m';
      }
      map.on('zoomend', updateScaleBar);
      map.on('moveend', updateScaleBar);
      updateScaleBar();
    }

    function zoomToVisibleMarkers() {
      const filtered = getFilteredBuildings();
      if (filtered.length === 0) return;

      const bounds = L.latLngBounds(filtered.map(b => [b.lat, b.lng]));
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    function createMarker(building) {
      const icon = L.divIcon({
        className: 'custom-marker-container',
        html: `<div class="custom-marker ${building.priority}" data-id="${building.id}"></div>
               <span class="marker-label">${building.id}</span>`,
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });

      // Create with draggable: true so dragging handler is available
      // It will be disabled immediately after adding to map
      const marker = L.marker([building.lat, building.lng], { icon, draggable: true });
      marker.on('click', () => selectBuilding(building.id));
      return marker;
    }

    // ========================================
    // Rendering Functions
    // ========================================
    function renderDetailPanel(building) {
      const detailPanel = document.getElementById('detail-panel');
      const wasVisible = detailPanel.classList.contains('visible');

      if (!building) {
        detailPanel.classList.remove('visible');
        // Resize map after panel hides
        if (wasVisible && map) {
          setTimeout(() => map.invalidateSize(), 10);
        }
        return;
      }

      detailPanel.classList.add('visible');
      // Resize map after panel shows
      if (!wasVisible && map) {
        setTimeout(() => map.invalidateSize(), 10);
      }

      document.getElementById('detail-title').textContent = building.name;
      document.getElementById('detail-sap-id').textContent = building.id;

      // Confidence
      const totalClass = building.confidence.total < 50 ? 'critical' :
                         building.confidence.total < 80 ? 'warning' : 'ok';
      document.getElementById('confidence-total').textContent = building.confidence.total + '%';
      document.getElementById('confidence-total').className = 'confidence-total ' + totalClass;

      ['georef', 'sap', 'gwr'].forEach(key => {
        const val = building.confidence[key];
        const barClass = val < 50 ? 'critical' : val < 80 ? 'warning' : 'ok';
        document.getElementById(`bar-${key}`).style.width = val + '%';
        document.getElementById(`bar-${key}`).className = 'confidence-bar-fill ' + barClass;
        document.getElementById(`val-${key}`).textContent = val + '%';
      });

      // Errors
      document.getElementById('error-cards').innerHTML = building.errors.length > 0
        ? building.errors.map(error => `
            <div class="error-card ${error.severity}">
              <div class="error-card-header">
                <span class="badge badge-${error.type} badge-caps badge-sm">${getTagLabel(error.type)}</span>
                <span class="error-card-title">${error.title}</span>
              </div>
              <div class="error-card-desc">${error.description}</div>
            </div>
          `).join('')
        : '<p class="empty-text">Keine Fehler gefunden.</p>';

      // Update error count badge and auto-expand if errors
      const errorCountEl = document.getElementById('error-count');
      const fehlerAccordion = document.querySelector('[data-accordion="fehler"]');
      if (building.errors.length > 0) {
        errorCountEl.textContent = building.errors.length;
        errorCountEl.style.display = '';
        // Auto-expand errors section when there are errors
        fehlerAccordion.classList.add('open');
      } else {
        errorCountEl.style.display = 'none';
        fehlerAccordion.classList.remove('open');
      }

      // Data comparison
      renderDataComparison(building);

      // Comments
      document.getElementById('comments-list').innerHTML = building.comments.length > 0
        ? building.comments.map(comment => `
            <div class="comment ${comment.system ? 'system' : ''}">
              <div class="comment-header">
                <span class="comment-author">${comment.author}</span>
                <span class="comment-date">${comment.date}</span>
              </div>
              <div class="comment-text">${comment.text}</div>
            </div>
          `).join('')
        : '<p class="empty-text">Keine Kommentare.</p>';

      // Update comments count badge
      const commentsCountEl = document.getElementById('comments-count');
      if (building.comments.length > 0) {
        commentsCountEl.textContent = building.comments.length;
        commentsCountEl.style.display = '';
      } else {
        commentsCountEl.style.display = 'none';
      }

      // Status
      const statusEl = document.getElementById('detail-status');
      const statusLabels = {
        'backlog': 'Backlog',
        'inprogress': 'In Bearbeitung',
        'clarification': 'Klärung',
        'done': 'Erledigt'
      };
      const statusClasses = {
        'backlog': 'status-backlog',
        'inprogress': 'status-inprogress',
        'clarification': 'status-clarification',
        'done': 'status-done'
      };
      statusEl.textContent = statusLabels[building.kanbanStatus] || building.kanbanStatus;
      statusEl.className = 'status-badge ' + (statusClasses[building.kanbanStatus] || '');

      // Assignee
      renderAssigneeDisplay(building);

      // Events
      renderEventsLog(building.id);

      // Refresh Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Update edit button state
      updateEditButton();
    }

    function renderDataComparison(building) {
      const container = document.getElementById('data-comparison');
      const isEditMode = state.editMode;

      // Get current coords (may be edited)
      const currentLat = state.editedCoords ? state.editedCoords.lat : building.lat;
      const currentLng = state.editedCoords ? state.editedCoords.lng : building.lng;
      const sapCoords = `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`;

      container.innerHTML = Object.entries(building.data).map(([key, val]) => {
        const isCoords = key === 'coords';
        const sapValue = isCoords ? sapCoords : val.sap;
        const gwrValue = val.gwr;

        if (isEditMode) {
          // Edit mode rendering
          if (isCoords) {
            // Coordinates - read-only but shows live position, with map hint
            return `
              <tr class="edit-row">
                <td>${getDataLabel(key)}</td>
                <td class="edit-cell coords-cell">
                  <span class="coords-value" id="edit-coords-display">${sapValue}</span>
                  <span class="coords-hint"><i data-lucide="move" class="icon-xs"></i> Punkt verschieben</span>
                </td>
                <td class="gwr-locked">${gwrValue}</td>
              </tr>
            `;
          } else {
            // Regular editable field
            return `
              <tr class="edit-row">
                <td>${getDataLabel(key)}</td>
                <td class="edit-cell">
                  <input type="text" class="edit-input" data-field="${key}" value="${sapValue === '—' || sapValue === 'Fehlt' ? '' : sapValue}" placeholder="${gwrValue !== '—' ? gwrValue : ''}">
                </td>
                <td class="gwr-locked">${gwrValue}</td>
              </tr>
            `;
          }
        } else {
          // View mode rendering (original)
          return `
            <tr>
              <td>${getDataLabel(key)}</td>
              <td class="${val.match ? 'match' : (val.sap === 'Fehlt' || val.sap === '—' ? 'missing' : 'mismatch')}">${val.sap}</td>
              <td class="${val.match ? 'match' : (gwrValue === '—' ? 'missing' : 'mismatch')}">${gwrValue}</td>
            </tr>
          `;
        }
      }).join('');

      // Update button section
      updateEditButton();
    }

    function updateEditButton() {
      const btnCorrect = document.getElementById('btn-correct');
      const editActionsContainer = document.getElementById('edit-actions');

      if (state.editMode) {
        btnCorrect.style.display = 'none';
        if (editActionsContainer) {
          editActionsContainer.style.display = 'flex';
        }
      } else {
        btnCorrect.style.display = 'flex';
        if (editActionsContainer) {
          editActionsContainer.style.display = 'none';
        }
      }
    }

    function enterEditMode() {
      if (!state.selectedBuildingId) return;
      const building = buildings.find(b => b.id === state.selectedBuildingId);
      if (!building) return;

      // Store original data for cancel
      state.originalBuildingData = JSON.parse(JSON.stringify(building.data));
      state.editedCoords = { lat: building.lat, lng: building.lng };
      state.editMode = true;

      // Make marker draggable (Leaflet API)
      const marker = markers[building.id];
      if (marker) {
        // Enable dragging on Leaflet marker
        if (marker.dragging) {
          marker.dragging.enable();
        }
        // Add draggable class to marker icon
        if (marker._icon) {
          marker._icon.classList.add('draggable');
        }

        // Add drag event listener
        marker.on('drag', (e) => {
          const latLng = e.target.getLatLng();
          state.editedCoords = { lat: latLng.lat, lng: latLng.lng };
          // Update coords display in real-time
          const coordsDisplay = document.getElementById('edit-coords-display');
          if (coordsDisplay) {
            coordsDisplay.textContent = `${latLng.lat.toFixed(4)}, ${latLng.lng.toFixed(4)}`;
          }
        });
      }

      // Re-render data comparison in edit mode
      renderDataComparison(building);

      // Add edit mode class to detail panel
      document.getElementById('detail-panel')?.classList.add('edit-mode');

      // Refresh icons for new elements
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function exitEditMode(save) {
      if (!state.selectedBuildingId) return;
      const building = buildings.find(b => b.id === state.selectedBuildingId);
      if (!building) return;

      const marker = markers[building.id];

      if (save) {
        // Collect edited values from inputs
        document.querySelectorAll('.edit-input').forEach(input => {
          const field = input.dataset.field;
          const newValue = input.value.trim() || '—';
          if (building.data[field]) {
            building.data[field].sap = newValue;
            // Update match status
            building.data[field].match = newValue === building.data[field].gwr;
          }
        });

        // Update coordinates from dragged marker
        if (state.editedCoords) {
          building.lat = state.editedCoords.lat;
          building.lng = state.editedCoords.lng;
          // Update coords in data
          if (building.data.coords) {
            building.data.coords.sap = `${state.editedCoords.lat.toFixed(4)}, ${state.editedCoords.lng.toFixed(4)}`;
            // Check if matches GWR coords
            const gwrCoords = building.data.coords.gwr;
            if (gwrCoords && gwrCoords !== '—') {
              const [gwrLat, gwrLng] = gwrCoords.split(',').map(s => parseFloat(s.trim()));
              const tolerance = 0.001; // ~100m tolerance
              building.data.coords.match =
                Math.abs(state.editedCoords.lat - gwrLat) < tolerance &&
                Math.abs(state.editedCoords.lng - gwrLng) < tolerance;
            }
          }
        }

        // Update metadata
        building.lastUpdate = new Date().toISOString();
        building.lastUpdateBy = 'M. Keller';

        // Keep marker at new position (already there from drag)
      } else {
        // Cancel - restore original data
        if (state.originalBuildingData) {
          building.data = state.originalBuildingData;
        }

        // Reset marker to original position (Leaflet API)
        if (marker) {
          marker.setLatLng([building.lat, building.lng]);
        }
      }

      // Make marker non-draggable (Leaflet API)
      if (marker) {
        if (marker.dragging) {
          marker.dragging.disable();
        }
        if (marker._icon) {
          marker._icon.classList.remove('draggable');
        }
        marker.off('drag');
      }

      // Clear edit state
      state.editMode = false;
      state.originalBuildingData = null;
      state.editedCoords = null;

      // Remove edit mode class
      document.getElementById('detail-panel')?.classList.remove('edit-mode');

      // Re-render everything
      renderDataComparison(building);
      renderBuildingsList();
      updateStatistik();

      // Refresh icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function renderAssigneeDisplay(building) {
      const container = document.getElementById('assignee-display');
      const currentAssignee = building.assignee;
      const member = currentAssignee ? teamMembers.find(m => m.name === currentAssignee) : null;

      // Build trigger content
      let triggerContent;
      if (currentAssignee) {
        const initials = member ? member.initials : currentAssignee.split(' ').map(n => n[0]).join('');
        const role = member ? member.role : '';
        triggerContent = `
          <div class="assignee-avatar">${initials}</div>
          <div class="assignee-info">
            <div class="assignee-name">${currentAssignee}</div>
            ${role ? `<div class="assignee-role">${role}</div>` : ''}
          </div>
        `;
      } else {
        triggerContent = `
          <div class="assignee-avatar empty"><i data-lucide="user" class="icon-sm"></i></div>
          <div class="assignee-info">
            <span class="assignee-empty-text">Zuweisen...</span>
          </div>
        `;
      }

      // Build dropdown options
      const options = teamMembers.map(m => `
        <button class="assignee-option ${currentAssignee === m.name ? 'selected' : ''}" data-assignee="${m.name}">
          <div class="assignee-avatar">${m.initials}</div>
          <div class="assignee-option-info">
            <div class="assignee-option-name">${m.name}</div>
            <div class="assignee-option-role">${m.role}</div>
          </div>
          <i data-lucide="check" class="icon-sm assignee-option-check"></i>
        </button>
      `).join('');

      // Add unassign option if currently assigned
      const unassignOption = currentAssignee ? `
        <div class="assignee-divider"></div>
        <button class="assignee-option unassign" data-assignee="">
          <div class="assignee-avatar empty"><i data-lucide="user-minus" class="icon-sm"></i></div>
          <div class="assignee-option-info">
            <div class="assignee-option-name">Zuweisung aufheben</div>
          </div>
        </button>
      ` : '';

      container.innerHTML = `
        <button class="assignee-trigger" type="button">
          ${triggerContent}
          <i data-lucide="chevron-down" class="icon-sm assignee-chevron"></i>
        </button>
        <div class="assignee-dropdown">
          ${options}
          ${unassignOption}
        </div>
      `;

      // Setup event listeners
      const trigger = container.querySelector('.assignee-trigger');
      const dropdown = container.querySelector('.assignee-dropdown');

      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        container.classList.toggle('open');
      });

      // Handle option selection
      container.querySelectorAll('.assignee-option').forEach(option => {
        option.addEventListener('click', () => {
          const newAssignee = option.dataset.assignee || null;
          assignBuilding(building.id, newAssignee);
          container.classList.remove('open');
        });
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          container.classList.remove('open');
        }
      }, { once: true });

      // Refresh Lucide icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function assignBuilding(buildingId, assigneeName) {
      // Find building and update
      const building = buildings.find(b => b.id === buildingId);
      if (building) {
        building.assignee = assigneeName;
        building.lastUpdate = new Date().toISOString();
        building.lastUpdateBy = 'M. Keller'; // Current user

        // Re-render
        renderAssigneeDisplay(building);
        renderKanbanBoard();
        if (tableVisible) renderTableView();
        updateCounts();
      }
    }

    function renderEventsLog(buildingId) {
      const container = document.getElementById('events-list');
      const eventsCountEl = document.getElementById('events-count');
      const buildingEvents = events
        .filter(e => e.buildingId === buildingId)
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Update events count badge
      if (buildingEvents.length > 0) {
        eventsCountEl.textContent = buildingEvents.length;
        eventsCountEl.style.display = '';
      } else {
        eventsCountEl.style.display = 'none';
      }

      if (buildingEvents.length === 0) {
        container.innerHTML = '<p class="empty-text">Keine Ereignisse.</p>';
        return;
      }

      container.innerHTML = buildingEvents.map(event => `
        <div class="event-item">
          <div class="event-icon ${event.type}">
            ${getEventIcon(event.type)}
          </div>
          <div class="event-content">
            <div class="event-header">
              <span class="event-action">${event.action}</span>
              <span class="event-time">${formatEventTime(event.timestamp)}</span>
            </div>
            <div class="event-details">${event.details}</div>
            <div class="event-user">von ${event.user}</div>
          </div>
        </div>
      `).join('');
    }

    function getEventIcon(type) {
      const icons = {
        assignment: '<i data-lucide="user-plus" class="icon-sm"></i>',
        comment: '<i data-lucide="message-square" class="icon-sm"></i>',
        status: '<i data-lucide="refresh-cw" class="icon-sm"></i>',
        correction: '<i data-lucide="check-circle" class="icon-sm"></i>',
        detection: '<i data-lucide="alert-triangle" class="icon-sm"></i>'
      };
      return icons[type] || '<i data-lucide="circle" class="icon-sm"></i>';
    }

    function formatEventTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));

      if (diffDays === 0) {
        return date.toLocaleTimeString('de-CH', { hour: '2-digit', minute: '2-digit' });
      } else if (diffDays === 1) {
        return 'Gestern';
      } else if (diffDays < 7) {
        return `vor ${diffDays} Tagen`;
      } else {
        return date.toLocaleDateString('de-CH', { day: '2-digit', month: '2-digit', year: 'numeric' });
      }
    }

    function renderKanbanBoard() {
      const filtered = getFilteredBuildings();
      const columns = {
        backlog: filtered.filter(b => b.kanbanStatus === 'backlog'),
        inprogress: filtered.filter(b => b.kanbanStatus === 'inprogress'),
        clarification: filtered.filter(b => b.kanbanStatus === 'clarification'),
        done: filtered.filter(b => b.kanbanStatus === 'done')
      };

      Object.entries(columns).forEach(([status, items]) => {
        const container = document.getElementById(`kanban-${status}`);
        const displayItems = items.slice(0, 5);

        container.innerHTML = displayItems.map(building => `
          <div class="kanban-card ${building.priority}"
               draggable="true"
               data-building-id="${building.id}"
               data-status="${status}">
            <div class="kanban-card-name">${building.name}</div>
            <div class="kanban-card-sap-id">${building.id}</div>
            <div class="badge-group">
              ${building.errors.map(err => `<span class="badge badge-${err.type} badge-caps badge-sm">${getTagLabel(err.type)}</span>`).join('')}
            </div>
            <div class="kanban-card-meta">
              <span>${building.assignee || 'Nicht zugewiesen'}</span>
              <span class="meta-icon" title="${formatDateTime(building.lastUpdate)} von ${building.lastUpdateBy || '—'}"><i data-lucide="clock" class="icon-sm"></i> ${formatRelativeTime(building.lastUpdate)}</span>
            </div>
          </div>
        `).join('');

        if (items.length > 5) {
          container.innerHTML += `<div class="kanban-more">+${items.length - 5} mehr</div>`;
        }

        document.getElementById(`kanban-${status}-count`).textContent = items.length;
      });

      // Re-initialize Lucide icons for dynamically added content
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Setup drag and drop handlers for cards
      setupKanbanCardHandlers();
    }

    // ========================================
    // Kanban Drag and Drop
    // ========================================
    let draggedCard = null;
    let draggedBuildingId = null;

    function setupKanbanDragDrop() {
      const columns = document.querySelectorAll('.kanban-cards');

      columns.forEach(column => {
        column.addEventListener('dragover', handleDragOver);
        column.addEventListener('dragenter', handleDragEnter);
        column.addEventListener('dragleave', handleDragLeave);
        column.addEventListener('drop', handleDrop);
      });
    }

    function setupKanbanCardHandlers() {
      const cards = document.querySelectorAll('.kanban-card[draggable="true"]');

      cards.forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('click', (e) => {
          // Only trigger click if not dragging
          if (!card.classList.contains('dragging')) {
            selectBuildingAndSwitch(card.dataset.buildingId);
          }
        });
      });
    }

    function handleDragStart(e) {
      draggedCard = e.target;
      draggedBuildingId = e.target.dataset.buildingId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', draggedBuildingId);

      // Add visual feedback to valid drop targets
      document.querySelectorAll('.kanban-cards').forEach(col => {
        col.classList.add('drop-target');
      });
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedCard = null;
      draggedBuildingId = null;

      // Remove drop target styling
      document.querySelectorAll('.kanban-cards').forEach(col => {
        col.classList.remove('drop-target', 'drag-over');
      });
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }

    function handleDragEnter(e) {
      e.preventDefault();
      const column = e.target.closest('.kanban-cards');
      if (column) {
        column.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      const column = e.target.closest('.kanban-cards');
      if (column && !column.contains(e.relatedTarget)) {
        column.classList.remove('drag-over');
      }
    }

    function handleDrop(e) {
      e.preventDefault();
      const column = e.target.closest('.kanban-cards');
      if (!column || !draggedBuildingId) return;

      // Get the new status from the column ID
      const newStatus = column.id.replace('kanban-', '');

      // Find the building and update its status
      const building = buildings.find(b => b.id === draggedBuildingId);
      if (building && building.kanbanStatus !== newStatus) {
        building.kanbanStatus = newStatus;
        building.lastUpdate = new Date().toISOString();
        building.lastUpdateBy = 'M. Keller'; // Current user

        // Re-render the kanban board
        renderKanbanBoard();

        // Update the map markers and table if visible
        renderMarkers();
        renderTable();
      }

      column.classList.remove('drag-over');
    }

    // ========================================
    // Event Handlers
    // ========================================
    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });

      // Detail panel close button
      document.getElementById('detail-close-btn').addEventListener('click', () => {
        // Exit edit mode if active
        if (state.editMode) {
          exitEditMode(false);
        }
        state.selectedBuildingId = null;
        renderDetailPanel(null);
        // Deselect marker
        Object.values(markers).forEach(m => m.getElement()?.classList.remove('selected'));
        updateURL();
      });

      // Filter chips
      document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
        chip.addEventListener('click', () => toggleFilter(chip.dataset.filter));
      });

      // Multi-select filter dropdowns
      setupMultiSelectFilter('filter-kanton', 'filterKanton');
      setupMultiSelectFilter('filter-confidence', 'filterConfidence');
      setupMultiSelectFilter('filter-portfolio', 'filterPortfolio');
      setupMultiSelectFilter('filter-assignee', 'filterAssignee');

      // Basemap selector
      document.querySelectorAll('.basemap-btn').forEach(btn => {
        btn.addEventListener('click', () => switchBasemap(btn.dataset.basemap));
      });

      // Correct button - enters edit mode
      document.getElementById('btn-correct').addEventListener('click', () => {
        enterEditMode();
      });

      // Edit cancel button
      document.getElementById('btn-edit-cancel').addEventListener('click', () => {
        exitEditMode(false); // false = don't save
      });

      // Edit save button
      document.getElementById('btn-edit-save').addEventListener('click', () => {
        exitEditMode(true); // true = save changes
      });

      // Mark as done button
      document.getElementById('btn-done').addEventListener('click', () => {
        if (!state.selectedBuildingId) return;
        const building = buildings.find(b => b.id === state.selectedBuildingId);
        if (!building) return;

        // Update status to done
        building.kanbanStatus = 'done';
        building.lastUpdate = new Date().toISOString();
        building.lastUpdateBy = 'M. Keller';

        // Re-render
        renderDetailPanel(building);
        renderKanbanBoard();
        renderBuildingsList();
        updateStatistik();
      });

      // Global search
      document.getElementById('globalSearch').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        filterBySearch(query);
      });

      // Close modals on escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
          });
        }
      });

      // Close modals on backdrop click
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
          }
        });
      });

      // Comment input handlers
      document.getElementById('btn-submit-comment').addEventListener('click', submitComment);
      document.getElementById('btn-cancel-comment').addEventListener('click', cancelComment);
      document.getElementById('comment-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
          submitComment();
        }
      });
    }

    function submitComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (!text || !state.selectedBuildingId) return;

      const building = buildings.find(b => b.id === state.selectedBuildingId);
      if (!building) return;

      // Add new comment
      const newComment = {
        author: 'M. Keller',
        date: new Date().toLocaleDateString('de-CH'),
        text: text,
        system: false
      };
      building.comments.push(newComment);
      building.lastUpdate = new Date().toISOString();
      building.lastUpdateBy = 'M. Keller';

      // Clear input and re-render
      input.value = '';
      renderDetailPanel(building);
    }

    function cancelComment() {
      document.getElementById('comment-input').value = '';
    }

    function switchTab(tabId, shouldUpdateURL = true) {
      state.currentTab = tabId;

      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabId);
      });

      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabId}`);
      });

      // Toggle body class for settings tab (allows page scrolling)
      document.body.classList.toggle('settings-tab-active', tabId === 'settings');

      if (tabId === 'karte') {
        setTimeout(() => map.invalidateSize(), 100);
      }

      if (shouldUpdateURL) updateURL();
    }

    function selectBuilding(id, shouldUpdateURL = true) {
      // Exit edit mode if switching buildings
      if (state.editMode && state.selectedBuildingId !== id) {
        exitEditMode(false); // Cancel without saving
      }

      state.selectedBuildingId = id;
      const building = buildings.find(b => b.id === id);

      // Update list selection
      document.querySelectorAll('.list-item').forEach(item => {
        item.classList.toggle('selected', item.dataset.id === id);
      });

      // Update map marker
      Object.entries(markers).forEach(([markerId, marker]) => {
        const isSelected = markerId === id;
        const markerBuilding = buildings.find(b => b.id === markerId);
        marker.setIcon(L.divIcon({
          className: 'custom-marker-container',
          html: `<div class="custom-marker ${markerBuilding.priority} ${isSelected ? 'selected' : ''}" data-id="${markerId}"></div>
                 <span class="marker-label">${markerId}</span>`,
          iconSize: isSelected ? [24, 24] : [16, 16],
          iconAnchor: isSelected ? [12, 12] : [8, 8]
        }));
      });

      // Center map on selected building (zoom 18 = street/building level)
      if (building) {
        map.setView([building.lat, building.lng], 18);
      }

      // Update detail panel
      renderDetailPanel(building);

      // Update table view if visible
      if (tableVisible) renderTableView();

      if (shouldUpdateURL) updateURL();
    }

    function selectBuildingAndSwitch(id) {
      switchTab('karte');
      setTimeout(() => selectBuilding(id), 100);
    }

    function toggleFilter(filterName, shouldUpdateURL = true) {
      if (filterName === 'my-tasks') {
        state.activeFilters.myTasks = !state.activeFilters.myTasks;
      } else {
        state.activeFilters[filterName] = !state.activeFilters[filterName];
      }

      document.querySelectorAll(`.filter-chip[data-filter="${filterName}"]`).forEach(chip => {
        chip.classList.toggle('active', state.activeFilters[filterName] ||
          (filterName === 'my-tasks' && state.activeFilters.myTasks));
      });

      applyFilters(shouldUpdateURL);
    }

    function setupMultiSelectFilter(elementId, stateKey) {
      const container = document.getElementById(elementId);
      const trigger = container.querySelector('.multi-select-trigger');
      const dropdown = container.querySelector('.multi-select-dropdown');
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const allBtn = container.querySelector('[data-action="all"]');
      const noneBtn = container.querySelector('[data-action="none"]');
      const label = container.querySelector('.multi-select-label');

      // Toggle dropdown
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close other dropdowns
        document.querySelectorAll('.multi-select.open').forEach(el => {
          if (el !== container) el.classList.remove('open');
        });
        container.classList.toggle('open');
      });

      // Close on outside click
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          container.classList.remove('open');
        }
      });

      // Checkbox change
      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          updateMultiSelectState();
        });
      });

      // Select all
      allBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = true);
        updateMultiSelectState();
      });

      // Select none
      noneBtn.addEventListener('click', () => {
        checkboxes.forEach(cb => cb.checked = false);
        updateMultiSelectState();
      });

      function updateMultiSelectState() {
        const selected = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
        // Empty array = show all, specific values = show only those
        // If nothing selected, use special marker that won't match any real value
        if (selected.length === checkboxes.length) {
          state[stateKey] = []; // All selected = show all
        } else if (selected.length === 0) {
          state[stateKey] = ['__NONE__']; // None selected = show none
        } else {
          state[stateKey] = selected; // Some selected = show only those
        }
        updateLabel();
        applyFilters();
      }

      function updateLabel() {
        const selected = Array.from(checkboxes).filter(cb => cb.checked);
        const hasPartialSelection = selected.length > 0 && selected.length < checkboxes.length;

        // Toggle has-selection class for visual styling
        container.classList.toggle('has-selection', hasPartialSelection);

        if (selected.length === 0) {
          label.textContent = label.dataset.default || elementId.replace('filter-', '');
          label.classList.add('none-selected');
        } else if (selected.length === checkboxes.length) {
          label.textContent = label.dataset.default || elementId.replace('filter-', '');
          label.classList.remove('none-selected');
        } else if (selected.length === 1) {
          label.textContent = selected[0].nextElementSibling.textContent;
          label.classList.remove('none-selected');
        } else {
          label.textContent = `${selected.length} ausgewählt`;
          label.classList.remove('none-selected');
        }
      }

      // Initialize: all checked by default
      checkboxes.forEach(cb => cb.checked = true);
      label.dataset.default = label.textContent;
    }

    function applyMultiSelectState(elementId, selectedValues) {
      const container = document.getElementById(elementId);
      if (!container) return;

      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      const label = container.querySelector('.multi-select-label');

      // Initialize label.dataset.default if not already set (in case this runs before setupMultiSelectFilter)
      if (label && !label.dataset.default) {
        label.dataset.default = label.textContent;
      }

      // If empty array, check all (show all)
      if (selectedValues.length === 0) {
        checkboxes.forEach(cb => cb.checked = true);
        container.classList.remove('has-selection');
        if (label && label.dataset.default) {
          label.textContent = label.dataset.default;
          label.classList.remove('none-selected');
        }
      } else if (selectedValues.includes('__NONE__')) {
        // Special case: none selected (show none)
        checkboxes.forEach(cb => cb.checked = false);
        container.classList.remove('has-selection');
        if (label && label.dataset.default) {
          label.textContent = label.dataset.default;
          label.classList.add('none-selected');
        }
      } else {
        // Check only selected values
        checkboxes.forEach(cb => {
          cb.checked = selectedValues.includes(cb.value);
        });
        // Update label
        if (label && label.dataset.default) {
          const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
          const hasPartialSelection = checkedCount > 0 && checkedCount < checkboxes.length;
          container.classList.toggle('has-selection', hasPartialSelection);
          label.classList.remove('none-selected');
          if (checkedCount === checkboxes.length) {
            label.textContent = label.dataset.default;
          } else if (checkedCount === 1) {
            const cb = Array.from(checkboxes).find(cb => cb.checked);
            label.textContent = cb ? cb.nextElementSibling.textContent : selectedValues[0];
          } else {
            label.textContent = `${checkedCount} ausgewählt`;
          }
        }
      }
    }

    function applyFilters(shouldUpdateURL = true) {
      updateMapMarkers();
      updateCounts();
      updateStatistik();
      renderKanbanBoard();
      if (tableVisible) renderTableView();
      if (shouldUpdateURL) updateURL();
    }

    function getFilteredBuildings() {
      return buildings.filter(building => {
        // Search filter
        if (searchQuery) {
          const matchesSearch = building.name.toLowerCase().includes(searchQuery) ||
                                building.id.toLowerCase().includes(searchQuery);
          if (!matchesSearch) return false;
        }

        // Priority filters (if none selected, show all; if any selected, filter to those)
        const anyPrioritySelected = state.activeFilters.high || state.activeFilters.medium || state.activeFilters.low;
        if (anyPrioritySelected && !state.activeFilters[building.priority]) {
          return false;
        }

        // My tasks filter
        if (state.activeFilters.myTasks && building.assignee !== 'M. Keller') {
          return false;
        }

        // Kanton filter (empty array = show all)
        if (state.filterKanton.length > 0 && !state.filterKanton.includes(building.kanton)) {
          return false;
        }

        // Confidence filter (empty array = show all)
        if (state.filterConfidence.length > 0) {
          const conf = building.confidence.total;
          const confLevel = conf < 50 ? 'critical' : conf < 80 ? 'warning' : 'ok';
          if (!state.filterConfidence.includes(confLevel)) return false;
        }

        // Portfolio filter (empty array = show all)
        if (state.filterPortfolio.length > 0 && !state.filterPortfolio.includes(building.portfolio)) {
          return false;
        }

        // Assignee filter (empty array = show all, empty string matches unassigned)
        if (state.filterAssignee.length > 0) {
          const assignee = building.assignee || '';
          if (!state.filterAssignee.includes(assignee)) return false;
        }

        return true;
      });
    }

    function updateMapMarkers() {
      const filteredIds = new Set(getFilteredBuildings().map(b => b.id));

      Object.entries(markers).forEach(([id, marker]) => {
        if (filteredIds.has(id)) {
          marker.addTo(map);
        } else {
          marker.remove();
        }
      });
    }

    function updateCounts() {
      const counts = { high: 0, medium: 0, low: 0 };
      buildings.forEach(b => {
        if (counts[b.priority] !== undefined) counts[b.priority]++;
      });

      Object.entries(counts).forEach(([priority, count]) => {
        const el = document.getElementById(`count-${priority}`);
        if (el) el.textContent = `(${count})`;
      });

      // Update filter total counts
      const filtered = getFilteredBuildings();
      const filteredCountEl = document.getElementById('filtered-count');
      const totalCountEl = document.getElementById('total-count');
      if (filteredCountEl) filteredCountEl.textContent = filtered.length;
      if (totalCountEl) totalCountEl.textContent = buildings.length;
    }

    function updateStatistik() {
      const filtered = getFilteredBuildings();

      // Helper to get initials from name
      const getInitials = (name) => {
        if (!name) return '?';
        return name.split(' ').map(n => n[0]).join('').toUpperCase();
      };

      if (filtered.length === 0) {
        // Reset to zero state
        document.getElementById('stat-total').textContent = '0';
        document.getElementById('stat-quality').textContent = '—';
        document.getElementById('stat-errors').textContent = '0';
        document.getElementById('stat-critical').textContent = '0';
        document.getElementById('stat-validated').textContent = '0';
        document.getElementById('stat-pending').textContent = '0';
        return;
      }

      // Calculate KPIs
      const totalCount = filtered.length;
      const avgConfidence = Math.round(filtered.reduce((sum, b) => sum + b.confidence.total, 0) / filtered.length);
      const criticalCount = filtered.filter(b => b.confidence.total < 50).length;
      const validatedCount = filtered.filter(b => b.confidence.total >= 90).length;
      const pendingCount = filtered.filter(b => b.kanbanStatus !== 'done').length;

      // Count total errors (all data mismatches)
      let totalErrors = 0;
      filtered.forEach(b => {
        if (b.data) {
          Object.values(b.data).forEach(field => {
            if (field && field.match === false) totalErrors++;
          });
        }
      });

      // Update KPI cards
      document.getElementById('stat-total').textContent = totalCount;
      document.getElementById('stat-quality').textContent = avgConfidence + '%';
      document.getElementById('stat-errors').textContent = totalErrors;
      document.getElementById('stat-critical').textContent = criticalCount;
      document.getElementById('stat-validated').textContent = validatedCount;
      document.getElementById('stat-pending').textContent = pendingCount;

      // Calculate confidence distribution for histogram
      const confBuckets = { critical: 0, warning: 0, moderate: 0, success: 0 };
      filtered.forEach(b => {
        const conf = b.confidence.total;
        if (conf < 40) confBuckets.critical++;
        else if (conf < 60) confBuckets.warning++;
        else if (conf < 80) confBuckets.moderate++;
        else confBuckets.success++;
      });

      // Update histogram chart
      const maxBucket = Math.max(...Object.values(confBuckets), 1);
      const histogramEl = document.getElementById('confidence-histogram');
      if (histogramEl) {
        const groups = histogramEl.querySelectorAll('.histogram-bar-group');
        const bucketKeys = ['critical', 'warning', 'moderate', 'success'];
        groups.forEach((group, i) => {
          const bar = group.querySelector('.histogram-bar');
          const value = group.querySelector('.histogram-value');
          const count = confBuckets[bucketKeys[i]];
          const height = Math.max((count / maxBucket) * 100, count > 0 ? 5 : 0);
          bar.style.height = height + '%';
          value.textContent = count;
        });
      }

      // Calculate errors by severity (based on data mismatches)
      let errorCount = 0, warningCount = 0, infoCount = 0;
      filtered.forEach(b => {
        const conf = b.confidence.total;
        if (conf < 50) errorCount++;
        else if (conf < 80) warningCount++;
        else if (conf < 90) infoCount++;
      });

      // Update severity chart
      const maxSeverity = Math.max(errorCount, warningCount, infoCount, 1);
      const severityChart = document.getElementById('severity-chart');
      if (severityChart) {
        const rows = severityChart.querySelectorAll('.severity-bar-row');
        const severityCounts = [errorCount, warningCount, infoCount];
        rows.forEach((row, i) => {
          const fill = row.querySelector('.severity-bar-fill');
          const value = row.querySelector('.severity-value');
          const width = (severityCounts[i] / maxSeverity) * 100;
          fill.style.width = width + '%';
          value.textContent = severityCounts[i];
        });
      }

      // Calculate mismatches by source
      const sourceCounts = { georef: 0, gwr: 0, sap: 0, address: 0 };
      filtered.forEach(b => {
        if (b.confidence.georef < 80) sourceCounts.georef++;
        if (b.confidence.gwr < 80) sourceCounts.gwr++;
        if (b.confidence.sap < 80) sourceCounts.sap++;
        if (b.data && b.data.address && !b.data.address.match) sourceCounts.address++;
      });

      // Update source chart
      const maxSource = Math.max(...Object.values(sourceCounts), 1);
      const sourceChart = document.getElementById('source-chart');
      if (sourceChart) {
        const rows = sourceChart.querySelectorAll('.chart-row');
        const sourceKeys = ['georef', 'gwr', 'sap', 'address'];
        rows.forEach((row, i) => {
          const fill = row.querySelector('.chart-row-fill');
          const value = row.querySelector('.chart-row-value');
          const count = sourceCounts[sourceKeys[i]];
          const width = (count / maxSource) * 100;
          fill.style.width = width + '%';
          value.textContent = count;
        });
      }

      // Calculate average confidence by canton
      const kantonData = {};
      filtered.forEach(b => {
        if (!kantonData[b.kanton]) {
          kantonData[b.kanton] = { sum: 0, count: 0 };
        }
        kantonData[b.kanton].sum += b.confidence.total;
        kantonData[b.kanton].count++;
      });

      // Sort by average confidence and take top 5
      const kantonAvgs = Object.entries(kantonData)
        .map(([kanton, data]) => ({ kanton, avg: Math.round(data.sum / data.count) }))
        .sort((a, b) => b.avg - a.avg)
        .slice(0, 5);

      // Update kanton chart
      const kantonChart = document.getElementById('kanton-chart');
      if (kantonChart) {
        kantonChart.innerHTML = kantonAvgs.map(k => `
          <div class="kanton-row">
            <span class="kanton-label">${k.kanton}</span>
            <div class="kanton-bar-track">
              <div class="kanton-bar-fill" style="width: ${k.avg}%"></div>
            </div>
            <span class="kanton-value">${k.avg}%</span>
          </div>
        `).join('');
      }

      // Calculate tasks per assignee
      const assigneeData = {};
      filtered.forEach(b => {
        const assignee = b.assignee || 'Nicht zugewiesen';
        if (!assigneeData[assignee]) {
          assigneeData[assignee] = 0;
        }
        assigneeData[assignee]++;
      });

      // Sort by count and render assignee chart
      const assigneeCounts = Object.entries(assigneeData)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count);

      const maxAssignee = Math.max(...assigneeCounts.map(a => a.count), 1);
      const assigneeChart = document.getElementById('assignee-chart');
      if (assigneeChart) {
        assigneeChart.innerHTML = assigneeCounts.map(a => `
          <div class="assignee-row">
            <div class="assignee-avatar-small">${getInitials(a.name === 'Nicht zugewiesen' ? '?' : a.name)}</div>
            <span class="assignee-name">${a.name === 'Nicht zugewiesen' ? 'Offen' : a.name.split(' ')[1] || a.name}</span>
            <div class="assignee-bar-track">
              <div class="assignee-bar-fill" style="width: ${(a.count / maxAssignee) * 100}%"></div>
            </div>
            <span class="assignee-value">${a.count}</span>
          </div>
        `).join('');
      }

      // Calculate status by portfolio
      const portfolioData = {};
      filtered.forEach(b => {
        if (!portfolioData[b.portfolio]) {
          portfolioData[b.portfolio] = { sum: 0, count: 0 };
        }
        portfolioData[b.portfolio].sum += b.confidence.total;
        portfolioData[b.portfolio].count++;
      });

      // Sort by average confidence
      const portfolioAvgs = Object.entries(portfolioData)
        .map(([portfolio, data]) => ({ portfolio, avg: Math.round(data.sum / data.count), count: data.count }))
        .sort((a, b) => b.avg - a.avg);

      // Update portfolio chart
      const portfolioChart = document.getElementById('portfolio-chart');
      if (portfolioChart) {
        portfolioChart.innerHTML = portfolioAvgs.map(p => `
          <div class="portfolio-row">
            <span class="portfolio-label">${p.portfolio}</span>
            <div class="portfolio-bar-track">
              <div class="portfolio-bar-fill" style="width: ${p.avg}%"></div>
            </div>
            <span class="portfolio-value">${p.avg}%</span>
          </div>
        `).join('');
      }
    }

    function switchBasemap(basemap) {
      document.querySelectorAll('.basemap-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.basemap === basemap);
      });

      // In a real app, you would switch tile layers here
      // For the prototype, we just update the active state
    }

    // Search state
    let searchQuery = '';

    function filterBySearch(query) {
      searchQuery = query.toLowerCase();

      // Update map markers based on search
      const filtered = getFilteredBuildings();
      const filteredIds = new Set(filtered.map(b => b.id));

      Object.entries(markers).forEach(([id, marker]) => {
        if (filteredIds.has(id)) {
          marker.addTo(map);
        } else {
          marker.remove();
        }
      });

      // Update kanban board, table view and statistics
      renderKanbanBoard();
      if (tableVisible) renderTableView();
      updateCounts();
      updateStatistik();
    }

    // ========================================
    // Modal Functions
    // ========================================
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // ========================================
    // Handbuch Functions
    // ========================================
    function toggleDocItem(element) {
      const item = element.closest('.doc-item');
      const children = item.querySelector('.doc-children');
      const icon = element.querySelector('.doc-item-icon');

      if (children) {
        children.classList.toggle('expanded');
        icon.textContent = children.classList.contains('expanded') ? '▾' : '▸';
      }
    }

    // ========================================
    // Utility Functions
    // ========================================
    function getTagLabel(tag) {
      const labels = {
        georef: 'Georef',
        sap: 'SAP',
        gwr: 'GWR',
        address: 'Adresse'
      };
      return labels[tag] || tag;
    }

    function getDataLabel(key) {
      const labels = {
        address: 'Adresse',
        plz: 'PLZ',
        coords: 'Koordinaten (WGS 84)',
        egid: 'EGID',
        year: 'Baujahr'
      };
      return labels[key] || key;
    }

    function formatRelativeTime(isoString) {
      if (!isoString) return '—';
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Gerade eben';
      if (diffMins < 60) return `vor ${diffMins} Min.`;
      if (diffHours < 24) return `vor ${diffHours} Std.`;
      if (diffDays === 1) return 'Gestern';
      if (diffDays < 7) return `vor ${diffDays} Tagen`;
      if (diffDays < 30) return `vor ${Math.floor(diffDays / 7)} Wochen`;
      return date.toLocaleDateString('de-CH');
    }

    function formatDateTime(isoString) {
      if (!isoString) return '—';
      const date = new Date(isoString);
      return date.toLocaleString('de-CH', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ========================================
    // Table View Functions
    // ========================================
    let tableVisible = true;

    function toggleTableView() {
      tableVisible = !tableVisible;
      const tablePanel = document.getElementById('table-panel');
      const toggleBtn = document.getElementById('table-toggle-btn');

      if (tableVisible) {
        tablePanel.classList.add('visible');
        toggleBtn.classList.add('active');
        renderTableView();
        // Resize map after table is shown
        setTimeout(() => map.invalidateSize(), 100);
      } else {
        tablePanel.classList.remove('visible');
        toggleBtn.classList.remove('active');
        // Resize map after table is hidden
        setTimeout(() => map.invalidateSize(), 100);
      }

      updateURL();
    }

    function closeTableView() {
      tableVisible = false;
      document.getElementById('table-panel').classList.remove('visible');
      document.getElementById('table-toggle-btn').classList.remove('active');
      setTimeout(() => map.invalidateSize(), 100);
      updateURL();
    }

    function renderTableView() {
      const filteredBuildings = getFilteredBuildings();
      const tbody = document.getElementById('table-body');

      const priorityConfig = {
        high: { label: 'Hoch', badge: 'badge-critical' },
        medium: { label: 'Mittel', badge: 'badge-warning' },
        low: { label: 'Niedrig', badge: 'badge-ok' }
      };

      tbody.innerHTML = filteredBuildings.map(building => {
        const priority = priorityConfig[building.priority] || { label: building.priority, badge: '' };
        return `
        <tr class="${state.selectedBuildingId === building.id ? 'selected' : ''}"
            onclick="selectBuilding('${building.id}')">
          <td>
            <span class="badge ${priority.badge}">${priority.label}</span>
          </td>
          <td>${building.id}</td>
          <td>${building.name}</td>
          <td>${building.kanton}</td>
          <td>
            <span class="confidence-value ${building.confidence.total < 50 ? 'critical' : building.confidence.total < 80 ? 'warning' : 'ok'}">
              ${building.confidence.total}%
            </span>
          </td>
          <td>
            <div class="badge-group">
              ${building.errors.map(err => `<span class="badge badge-${err.type} badge-caps badge-sm">${getTagLabel(err.type)}</span>`).join('')}
              ${building.errors.length === 0 ? '<span class="text-muted">—</span>' : ''}
            </div>
          </td>
          <td>${building.assignee ? `<span class="text-secondary">${building.assignee}</span>` : '<span class="text-muted">—</span>'}</td>
          <td class="text-muted" title="${formatDateTime(building.lastUpdate)} von ${building.lastUpdateBy || '—'}">${formatRelativeTime(building.lastUpdate)}</td>
        </tr>
      `}).join('');

      document.getElementById('table-count').textContent = `(${filteredBuildings.length})`;
    }

    // Setup table view event listeners
    function setupTableViewListeners() {
      document.getElementById('table-toggle-btn').addEventListener('click', toggleTableView);
      document.getElementById('table-close-btn').addEventListener('click', closeTableView);
    }

    // ========================================
    // Expanding Search Bar
    // ========================================
    function setupExpandingSearch() {
      const searchContainer = document.getElementById('search-container');
      const searchToggle = document.getElementById('search-toggle');
      const searchInput = document.getElementById('globalSearch');

      searchToggle.addEventListener('click', () => {
        searchContainer.classList.add('expanded');
        searchInput.focus();
      });

      searchInput.addEventListener('blur', () => {
        // Collapse if empty
        if (!searchInput.value.trim()) {
          searchContainer.classList.remove('expanded');
        }
      });

      // Handle Escape to close
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchInput.value = '';
          searchInput.blur();
          searchContainer.classList.remove('expanded');
          filterBySearch('');
        }
      });
    }

    // ========================================
    // Filter Bar Toggle
    // ========================================
    let filterBarVisible = true;

    function setupFilterToggle() {
      const filterToggle = document.getElementById('filter-toggle');
      const filterBar = document.getElementById('filter-bar');
      const filterReset = document.getElementById('filter-reset');

      filterToggle.addEventListener('click', () => {
        filterBarVisible = !filterBarVisible;
        filterBar.classList.toggle('hidden', !filterBarVisible);
        filterToggle.classList.toggle('active', filterBarVisible);
      });

      // Reset all filters to default
      filterReset.addEventListener('click', () => {
        // Reset priority filters to default (none selected = show all)
        state.activeFilters = { high: false, medium: false, low: false, myTasks: false };

        // Reset dropdown filters
        state.filterKanton = [];
        state.filterConfidence = [];
        state.filterPortfolio = [];
        state.filterAssignee = [];

        // Clear search
        searchQuery = '';
        document.getElementById('globalSearch').value = '';

        // Update filter chips UI - remove active from all (default = none selected)
        document.querySelectorAll('.filter-chip[data-filter]').forEach(chip => {
          chip.classList.remove('active');
        });

        // Reset multi-select dropdowns
        applyMultiSelectState('filter-kanton', []);
        applyMultiSelectState('filter-confidence', []);
        applyMultiSelectState('filter-portfolio', []);
        applyMultiSelectState('filter-assignee', []);

        // Apply filters and update URL
        applyFilters();
      });
    }

    // ========================================
    // Basemap Selector
    // ========================================
    let currentBasemap = 'color';
    let basemapLayer = null;

    const basemapConfigs = {
      none: {
        url: null,
        attribution: ''
      },
      grey: {
        url: 'https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png',
        attribution: '© OpenStreetMap © CARTO'
      },
      color: {
        url: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
        attribution: '© OpenStreetMap © CARTO'
      },
      satellite: {
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        attribution: '© Esri, Maxar, Earthstar Geographics'
      }
    };

    function switchBasemapTiles(basemapId) {
      const config = basemapConfigs[basemapId];

      // Remove existing basemap layer
      if (basemapLayer) {
        map.removeLayer(basemapLayer);
        basemapLayer = null;
      }

      // Add new basemap layer if not 'none'
      if (config.url) {
        basemapLayer = L.tileLayer(config.url, {
          attribution: config.attribution,
          maxZoom: 19
        });
        basemapLayer.addTo(map);
        basemapLayer.bringToBack();
      }
    }

    function setupBasemapSelector() {
      const selector = document.getElementById('basemap-selector');
      const trigger = document.getElementById('basemap-trigger');
      const triggerThumb = document.getElementById('basemap-trigger-thumb');
      const triggerLabel = document.getElementById('basemap-trigger-label');
      const panel = document.getElementById('basemap-panel');
      const options = document.querySelectorAll('.basemap-option');

      // Basemap labels for trigger display
      const basemapLabels = {
        none: 'Kein HG',
        grey: 'Grau',
        color: 'Farbig',
        satellite: 'Luftbild'
      };

      // Toggle panel on trigger click
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        selector.classList.toggle('expanded');
      });

      // Handle option selection
      options.forEach(option => {
        option.addEventListener('click', () => {
          const basemap = option.dataset.basemap;
          currentBasemap = basemap;

          // Update active state
          options.forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');

          // Update trigger thumbnail and title to show current basemap
          triggerThumb.className = 'basemap-thumb basemap-' + basemap;
          triggerLabel.textContent = basemapLabels[basemap] || basemap;

          // Switch the actual map tiles
          switchBasemapTiles(basemap);

          // Collapse the panel
          selector.classList.remove('expanded');
        });
      });

      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        if (!selector.contains(e.target)) {
          selector.classList.remove('expanded');
        }
      });

      // Close panel on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          selector.classList.remove('expanded');
        }
      });
    }

    // ========================================
    // Layer Widget
    // ========================================
    let overlayLayers = {};

    function setupLayerWidget() {
      const widget = document.getElementById('layer-widget');
      const trigger = document.getElementById('layer-widget-trigger');
      const header = widget.querySelector('.layer-widget-header');
      const checkboxes = widget.querySelectorAll('input[type="checkbox"]');
      const infoButtons = widget.querySelectorAll('.layer-info-btn');

      // Toggle collapse/expand
      trigger.addEventListener('click', () => {
        widget.classList.remove('collapsed');
      });

      header.addEventListener('click', () => {
        widget.classList.add('collapsed');
      });

      // Handle layer toggle
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          const layerId = checkbox.dataset.layer;
          if (checkbox.checked) {
            addOverlayLayer(layerId);
          } else {
            removeOverlayLayer(layerId);
          }
        });
      });

      // Handle info button clicks
      infoButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const layerId = btn.dataset.layer;
          showLayerInfo(layerId, btn);
        });
      });
    }

    // Layer configuration: some layers are WMS, others WMTS
    // minZoom based on Swisstopo tile matrix availability
    const layerConfig = {
      'ch.swisstopo-vd.stand-oerebkataster': { type: 'wms', minZoom: 8 },
      'ch.bfs.gebaeude_wohnungs_register': { type: 'wmts', minZoom: 13 }
    };

    function addOverlayLayer(layerId) {
      if (overlayLayers[layerId]) return;

      const config = layerConfig[layerId] || { type: 'wmts', minZoom: 8 };
      let layer;

      if (config.type === 'wms') {
        // Swisstopo WMS layer
        layer = L.tileLayer.wms('https://wms.geo.admin.ch/', {
          layers: layerId,
          format: 'image/png',
          transparent: true,
          attribution: '© swisstopo',
          opacity: 0.7,
          minZoom: config.minZoom || 8
        });
      } else {
        // Swisstopo WMTS layer
        layer = L.tileLayer(
          `https://wmts.geo.admin.ch/1.0.0/${layerId}/default/current/3857/{z}/{x}/{y}.png`,
          {
            attribution: '© swisstopo',
            maxZoom: 19,
            minZoom: config.minZoom || 13,
            opacity: 0.7
          }
        );
      }

      layer.addTo(map);
      overlayLayers[layerId] = layer;
    }

    function removeOverlayLayer(layerId) {
      if (overlayLayers[layerId]) {
        map.removeLayer(overlayLayers[layerId]);
        delete overlayLayers[layerId];
      }
      // Remove highlight layer when ÖREB is disabled
      if (layerId === 'ch.swisstopo-vd.stand-oerebkataster' && identifyHighlightLayer) {
        map.removeLayer(identifyHighlightLayer);
        identifyHighlightLayer = null;
      }
    }

    // Feature identification for clickable layers
    let identifyHighlightLayer = null;
    let identifyAbortController = null;

    function setupLayerIdentify() {
      map.on('click', async (e) => {
        // Only identify if ÖREB layer is enabled
        if (!overlayLayers['ch.swisstopo-vd.stand-oerebkataster']) return;

        // Don't identify if clicking on a marker
        if (e.originalEvent && e.originalEvent.target.closest('.custom-marker')) return;

        // Cancel any in-flight identify request to prevent race conditions
        if (identifyAbortController) {
          identifyAbortController.abort();
        }
        identifyAbortController = new AbortController();
        const currentController = identifyAbortController;

        const latlng = e.latlng;
        const bounds = map.getBounds();
        const size = map.getSize();
        const zoom = map.getZoom();

        // Adaptive tolerance based on zoom level
        // At low zoom (large area per pixel) use smaller tolerance for precision
        // At high zoom (small area per pixel) use larger tolerance for easier clicking
        const tolerance = zoom <= 10 ? 2 : zoom <= 12 ? 5 : zoom <= 14 ? 8 : 12;

        // Remove previous highlight before new request
        if (identifyHighlightLayer) {
          map.removeLayer(identifyHighlightLayer);
          identifyHighlightLayer = null;
        }

        // Use WGS84 coordinates with sr=4326
        const params = new URLSearchParams({
          geometry: `${latlng.lng},${latlng.lat}`,
          geometryType: 'esriGeometryPoint',
          imageDisplay: `${size.x},${size.y},96`,
          mapExtent: [
            bounds.getWest(),
            bounds.getSouth(),
            bounds.getEast(),
            bounds.getNorth()
          ].join(','),
          tolerance: tolerance,
          layers: 'all:ch.swisstopo-vd.stand-oerebkataster',
          returnGeometry: true,
          geometryFormat: 'geojson',
          sr: 4326,
          lang: 'de'
        });

        try {
          const response = await fetch(
            `https://api3.geo.admin.ch/rest/services/ech/MapServer/identify?${params}`,
            { signal: currentController.signal }
          );
          if (!response.ok) return;

          const data = await response.json();

          if (data.results && data.results.length > 0) {
            const feature = data.results[0];
            const attrs = feature.properties || feature.attributes || {};

            // Add polygon highlight
            if (feature.geometry) {
              identifyHighlightLayer = L.geoJSON(feature.geometry, {
                style: {
                  color: '#1a365d',
                  weight: 2,
                  fillColor: '#1a365d',
                  fillOpacity: 0.2
                }
              }).addTo(map);
            }

            // Build popup content
            const popupContent = `
              <div class="identify-popup">
                <strong>${attrs.gemeindename || 'Gemeinde'}</strong>
                <table class="identify-table">
                  <tr><td>BFS-Nr:</td><td>${attrs.bfs_nr || '-'}</td></tr>
                  <tr><td>Status:</td><td>${attrs.oereb_status_de || '-'}</td></tr>
                  <tr><td>Kontakt:</td><td>${attrs.email || '-'}</td></tr>
                  <tr><td>Telefon:</td><td>${attrs.telefon || '-'}</td></tr>
                </table>
                ${attrs.url_oereb ? `<a href="${attrs.url_oereb}" target="_blank" class="identify-link">ÖREB-Portal öffnen</a>` : ''}
              </div>
            `;

            L.popup()
              .setLatLng(latlng)
              .setContent(popupContent)
              .openOn(map);
          }
        } catch (error) {
          // Ignore abort errors (expected when user clicks rapidly)
          if (error.name !== 'AbortError') {
            console.error('Identify error:', error);
          }
        }
      });
    }

    async function showLayerInfo(layerId, buttonEl) {
      // Create or get modal element
      let modal = document.getElementById('layer-info-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'layer-info-modal';
        modal.className = 'layer-info-modal';
        modal.innerHTML = `
          <div class="layer-info-modal-content">
            <div class="layer-info-modal-header">
              <span class="layer-info-modal-title">Layer-Informationen</span>
              <button class="layer-info-modal-close"><i data-lucide="x" class="icon"></i></button>
            </div>
            <div class="layer-info-modal-body"></div>
          </div>
        `;
        document.body.appendChild(modal);
        lucide.createIcons({ nodes: [modal] });

        // Close button handler
        modal.querySelector('.layer-info-modal-close').addEventListener('click', () => {
          modal.classList.remove('visible');
        });

        // Close on overlay click
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('visible');
          }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('visible')) {
            modal.classList.remove('visible');
          }
        });
      }

      // Show loading state
      const bodyEl = modal.querySelector('.layer-info-modal-body');
      bodyEl.innerHTML = '<div class="layer-info-loading">Lade Informationen...</div>';
      modal.classList.add('visible');

      // Fetch legend HTML from geo.admin.ch
      try {
        const response = await fetch(`https://api3.geo.admin.ch/rest/services/api/MapServer/${layerId}/legend?lang=de`);
        const html = await response.text();
        bodyEl.innerHTML = html;
      } catch (error) {
        bodyEl.innerHTML = '<p>Metadaten konnten nicht geladen werden.</p>';
      }
    }

    // ========================================
    // Table Panel Resize
    // ========================================
    function setupTableResize() {
      const resizeHandle = document.getElementById('table-resize-handle');
      const tablePanel = document.getElementById('table-panel');
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;

      resizeHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = tablePanel.offsetHeight;
        resizeHandle.classList.add('dragging');
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        const deltaY = startY - e.clientY;
        const newHeight = Math.min(Math.max(startHeight + deltaY, 100), window.innerHeight * 0.7);
        tablePanel.style.height = newHeight + 'px';

        // Resize map to fit
        map.invalidateSize();
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          resizeHandle.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Touch support
      resizeHandle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startY = e.touches[0].clientY;
        startHeight = tablePanel.offsetHeight;
        resizeHandle.classList.add('dragging');
        e.preventDefault();
      });

      document.addEventListener('touchmove', (e) => {
        if (!isResizing) return;

        const deltaY = startY - e.touches[0].clientY;
        const newHeight = Math.min(Math.max(startHeight + deltaY, 100), window.innerHeight * 0.7);
        tablePanel.style.height = newHeight + 'px';
        map.invalidateSize();
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          resizeHandle.classList.remove('dragging');
        }
      });
    }

    // ========================================
    // Detail Panel Resize
    // ========================================
    function setupDetailPanelResize() {
      const resizeHandle = document.getElementById('detail-resize-handle');
      const detailPanel = document.getElementById('detail-panel');
      let isResizing = false;
      let startX = 0;
      let startWidth = 0;

      resizeHandle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = detailPanel.offsetWidth;
        resizeHandle.classList.add('dragging');
        document.body.style.cursor = 'ew-resize';
        document.body.style.userSelect = 'none';
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;

        // Dragging left increases width, dragging right decreases
        const deltaX = startX - e.clientX;
        const newWidth = Math.min(Math.max(startWidth + deltaX, 280), 600);
        detailPanel.style.width = newWidth + 'px';

        // Resize map to fit
        map.invalidateSize();
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          resizeHandle.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // Touch support
      resizeHandle.addEventListener('touchstart', (e) => {
        isResizing = true;
        startX = e.touches[0].clientX;
        startWidth = detailPanel.offsetWidth;
        resizeHandle.classList.add('dragging');
        e.preventDefault();
      });

      document.addEventListener('touchmove', (e) => {
        if (!isResizing) return;

        const deltaX = startX - e.touches[0].clientX;
        const newWidth = Math.min(Math.max(startWidth + deltaX, 280), 600);
        detailPanel.style.width = newWidth + 'px';
        map.invalidateSize();
      });

      document.addEventListener('touchend', () => {
        if (isResizing) {
          isResizing = false;
          resizeHandle.classList.remove('dragging');
        }
      });
    }

    // ========================================
    // Accordion Toggle
    // ========================================
    function setupAccordions() {
      document.querySelectorAll('.accordion-header').forEach(header => {
        header.addEventListener('click', () => {
          const accordion = header.closest('.accordion');
          accordion.classList.toggle('open');
        });
      });
    }

    // ========================================
    // Rules Display
    // ========================================
    function renderRules() {
      const container = document.getElementById('rules-container');
      if (!container || !rulesConfig) {
        container.innerHTML = '<div class="rules-empty">Keine Regeln verfügbar</div>';
        return;
      }

      const severityLabels = rulesConfig.severityLevels || {
        error: { label: 'Fehler', priority: 1 },
        warning: { label: 'Warnung', priority: 2 },
        info: { label: 'Hinweis', priority: 3 }
      };

      const html = rulesConfig.ruleSets.map(ruleSet => {
        const rulesHtml = ruleSet.rules.map(rule => {
          const severityInfo = severityLabels[rule.severity] || { label: rule.severity };
          return `
            <div class="rule-item">
              <span class="rule-severity ${rule.severity}"></span>
              <div class="rule-details">
                <div class="rule-header">
                  <span class="rule-name">${rule.name}</span>
                  <span class="rule-id">${rule.id}</span>
                </div>
                <p class="rule-description">${rule.description}</p>
                <div class="rule-meta">
                  <span class="rule-tag">${Array.isArray(rule.attribute) ? rule.attribute.join(', ') : rule.attribute}</span>
                  <span class="rule-tag">${rule.operator}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        const enabledStatus = ruleSet.enabled ? 'Aktiv' : 'Inaktiv';
        const enabledClass = ruleSet.enabled ? 'enabled' : 'disabled';

        return `
          <div class="rule-set" data-ruleset-id="${ruleSet.id}">
            <button class="rule-set-header" type="button">
              <div class="rule-set-info">
                <span class="rule-set-name">${ruleSet.name}</span>
                <span class="rule-set-count">${ruleSet.rules.length} Regeln</span>
                <span class="rule-set-status ${enabledClass}">${enabledStatus}</span>
              </div>
              <i data-lucide="chevron-down" class="icon-sm rule-set-chevron"></i>
            </button>
            <div class="rule-set-content">
              <p class="rule-set-description">${ruleSet.description}</p>
              <div class="rules-list">
                ${rulesHtml}
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = html;

      // Re-initialize icons
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Setup expand/collapse
      container.querySelectorAll('.rule-set-header').forEach(header => {
        header.addEventListener('click', () => {
          const ruleSet = header.closest('.rule-set');
          ruleSet.classList.toggle('expanded');
        });
      });
    }

    function setupRunChecksButton() {
      const runBtn = document.getElementById('run-all-checks');
      if (runBtn) {
        runBtn.addEventListener('click', () => {
          // Placeholder for future Python integration
          alert('Prüfung wird gestartet...\n\nDiese Funktion wird in Zukunft die Python-basierte Validierung auslösen.');
        });
      }
    }

    // ========================================
    // Map Context Menu (Right-Click)
    // ========================================
    let contextMenuLatLng = null;

    function setupContextMenu() {
      const contextMenu = document.getElementById('map-context-menu');
      const contextMenuCoords = document.getElementById('context-menu-coords');
      const contextMenuCoordsText = document.getElementById('context-menu-coords-text');
      const contextMenuShare = document.getElementById('context-menu-share');
      const contextMenuCenter = document.getElementById('context-menu-center');
      const contextMenuNearest = document.getElementById('context-menu-nearest');
      const mapContainer = document.getElementById('map');

      // Show context menu on right-click
      map.on('contextmenu', function(e) {
        e.originalEvent.preventDefault();

        // Store clicked coordinates
        contextMenuLatLng = e.latlng;

        // Update coordinates display
        const lat = contextMenuLatLng.lat.toFixed(5);
        const lng = contextMenuLatLng.lng.toFixed(5);
        contextMenuCoordsText.textContent = lat + ', ' + lng;
        contextMenuCoords.classList.remove('copied');

        // Get map container dimensions
        const mapRect = mapContainer.getBoundingClientRect();
        const menuWidth = 220;
        const menuHeight = 280;

        // Calculate click position relative to map
        const clickX = e.containerPoint.x;
        const clickY = e.containerPoint.y;

        // Edge detection
        const flipHorizontal = (clickX + menuWidth) > mapRect.width;
        const flipVertical = (clickY + menuHeight) > mapRect.height;

        // Position the menu relative to map container
        contextMenu.style.left = (mapRect.left + clickX) + 'px';
        contextMenu.style.top = (mapRect.top + clickY) + 'px';

        // Apply flip classes
        contextMenu.classList.toggle('flip-horizontal', flipHorizontal);
        contextMenu.classList.toggle('flip-vertical', flipVertical);

        // Show menu
        contextMenu.classList.add('show');

        // Refresh icons
        if (typeof lucide !== 'undefined') lucide.createIcons();
      });

      // Hide context menu function
      function hideContextMenu() {
        contextMenu.classList.remove('show');
      }

      // Hide on map click
      map.on('click', hideContextMenu);
      map.on('movestart', hideContextMenu);

      // Hide on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          hideContextMenu();
        }
      });

      // Hide when clicking outside
      document.addEventListener('click', function(e) {
        if (!contextMenu.contains(e.target)) {
          hideContextMenu();
        }
      });

      // Copy coordinates
      contextMenuCoords.addEventListener('click', function() {
        const coordsText = contextMenuCoordsText.textContent;
        navigator.clipboard.writeText(coordsText).then(function() {
          contextMenuCoords.classList.add('copied');
          setTimeout(hideContextMenu, 500);
        }).catch(function(err) {
          console.error('Failed to copy coordinates:', err);
        });
      });

      // Share location
      contextMenuShare.addEventListener('click', function() {
        if (!contextMenuLatLng) return;

        const lat = contextMenuLatLng.lat.toFixed(5);
        const lng = contextMenuLatLng.lng.toFixed(5);
        const zoom = Math.round(map.getZoom());
        const shareUrl = window.location.origin + window.location.pathname +
          '?tab=karte&lat=' + lat + '&lng=' + lng + '&zoom=' + zoom;

        hideContextMenu();

        if (navigator.share) {
          navigator.share({
            title: 'BBL Liegenschaftsinventar - Standort',
            text: 'Standort anzeigen:',
            url: shareUrl
          }).catch(function(err) {
            if (err.name !== 'AbortError') {
              navigator.clipboard.writeText(shareUrl);
            }
          });
        } else {
          navigator.clipboard.writeText(shareUrl);
        }
      });

      // Center map here
      contextMenuCenter.addEventListener('click', function() {
        if (!contextMenuLatLng) return;
        map.setView(contextMenuLatLng, map.getZoom());
        hideContextMenu();
      });

      // Find nearest building
      contextMenuNearest.addEventListener('click', function() {
        if (!contextMenuLatLng) return;

        let nearestBuilding = null;
        let minDistance = Infinity;

        buildings.forEach(function(building) {
          const distance = map.distance(contextMenuLatLng, [building.lat, building.lng]);
          if (distance < minDistance) {
            minDistance = distance;
            nearestBuilding = building;
          }
        });

        if (nearestBuilding) {
          selectBuilding(nearestBuilding.id);
        }

        hideContextMenu();
      });

      // Open in Google Maps
      const contextMenuGoogleMaps = document.getElementById('context-menu-google-maps');
      contextMenuGoogleMaps.addEventListener('click', function() {
        if (!contextMenuLatLng) return;
        const lat = contextMenuLatLng.lat.toFixed(6);
        const lng = contextMenuLatLng.lng.toFixed(6);
        const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        window.open(url, '_blank');
        hideContextMenu();
      });

      // Open in Swisstopo map.geo.admin.ch
      const contextMenuSwisstopo = document.getElementById('context-menu-swisstopo');
      contextMenuSwisstopo.addEventListener('click', function() {
        if (!contextMenuLatLng) return;
        // Convert WGS84 to LV95 coordinates (required by map.geo.admin.ch)
        const lv95 = wgs84ToLV95(contextMenuLatLng.lat, contextMenuLatLng.lng);
        const zoom = Math.round(map.getZoom());
        const url = `https://map.geo.admin.ch/#/map?lang=de&center=${lv95.E},${lv95.N}&z=${zoom}&topic=ech&layers=ch.swisstopo.amtliches-strassenverzeichnis;ch.bfs.gebaeude_wohnungs_register;ch.swisstopo-vd.stand-oerebkataster&bgLayer=ch.swisstopo.swissimage&crosshair=marker,${lv95.E},${lv95.N}`;
        window.open(url, '_blank');
        hideContextMenu();
      });

      // Open in Google Earth 3D
      const contextMenuGoogleEarth = document.getElementById('context-menu-google-earth');
      contextMenuGoogleEarth.addEventListener('click', function() {
        if (!contextMenuLatLng) return;
        const lat = contextMenuLatLng.lat.toFixed(6);
        const lng = contextMenuLatLng.lng.toFixed(6);
        // Google Earth URL format: @lat,lng,altitude_a,heading_y,tilt_h,range_t,rotation_r
        // 500a = 500m altitude, 35y = 35° heading, 60t = 60° tilt, 0r = 0° rotation
        const url = `https://earth.google.com/web/@${lat},${lng},500a,35y,60t,0r`;
        window.open(url, '_blank');
        hideContextMenu();
      });
    }
  </script>
</body>
</html>
